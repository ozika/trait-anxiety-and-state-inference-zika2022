---
title: "Statistics for anxiety & state inference project:  Main analyses"
author: "Ondrej Zika"
date: "4/7/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

if (!requireNamespace("pacman")) install.packages("pacman", "renv")
packages_cran <- c("renv")#c("here", "emmeans", "sjPlot", "sjmisc", "lme4", "lmerTest", "emmeans")
pacman::p_load(char = packages_cran)

renv::init()

library(lme4)
library(lmerTest)
library(emmeans)
#(sjPlot)
#library(sjmisc)
#library(ggplot2)
#library(Jmisc)
#library(reshape2)
#library(Hmisc)
#library(RColorBrewer)
#library(PupillometryR)
#library(plyr)
#library(ggeffects)
#library(ggpubr)
#library(dplyr)
#library(robustlmm)
#library(broom)
#library(tidyverse)
#library(tidyr)
#library(DHARMa) # https://cran.r-project.org/web/packages/DHARMa/vignettes/DHARMa.html



path_root = here::here("")
setwd(path_root)
figpath = here::here("output/figures/")
pubfigpath = here::here("paper-repo/figures/")
#rfunc = here::here("scripts/r_stats/r_functions.R")
rfunc = here::here("shared_functions/r/r_functions.R")
source(rfunc)
#sjplot https://strengejacke.github.io/sjPlot/articles/plot_marginal_effects.html

```

## 7. Ratings and error
### a. Ratings: stable cues

```{r}
data<-read.csv(paste(path_root, "/output/tables_and_csvs/prob_err_by_phase_STABLES_contingency.csv", sep=""))
#data["tabin"]<-dicho(data$ta)
data$trtype_str = to_factor(data$trtype_str)
data$study_str = to_factor(data$study_str)
data$id = to_factor(data$id)
data$contingency = to_factor(data$contingency)
data$ta <- demean(data$ta)
df<-data


m7a1<-lmer(prob ~ contingency*trtype_str + (1|id) + (1|study_str) , df)
m7a2<-lmer(prob ~ ta*contingency*trtype_str + (1|id) + (1|study_str), df)
#m7a2b<-lmer(prob ~ ta*contingency*trtype_str + (1|id) + (1+ta+contingency+trtype_str|study_str), df)
m7a3<-lmer(prob ~ tabin*contingency*trtype_str + (1|id)+ (1|study_str) , df)
anova(m7a1, m7a2,m7a2b, m7a3)


anova(m7a2)




# marginals and tests without anxiety
em7a2a = emmeans(m7a2, specs = pairwise ~ trtype_str)
em7a2a$emmeans

em7a2b = emmeans(m7a3, specs = pairwise ~ tabin*trtype_str)
em7a2b$emmeans

em7a2 = emmeans(m7a2, specs = pairwise ~ trtype_str*contingency)
em7a2$emmeans
em7a2$contrasts
em7a3 = emmeans(m7a3, specs = pairwise ~ tabin*trtype_str*contingency)
em7a3$emmeans

joint_tests(m7a2, by = "contingency")
joint_tests(m7a2, by = "trtype_str")
joint_tests(m7a2, by = c("trtype_str", "contingency"))


# relationship with anxiety
emtrends(m7a2, pairwise ~ trtype_str, var = "ta")

theme_set(theme_sjplot())
plot_model(m7a2, type = "pred", terms = c("ta", "trtype_str", "contingency"))


pr <- ggpredict(m7a2, "trtype_str", tyep = "fe", condition=c(contingency=c("75/25")))
pr
plot(pr)
```

### b. Ratings: reversal cue

```{r}
data<-read.csv(paste(path_root, "/output/tables_and_csvs/prob_err_by_phase_REV_contingency.csv", sep=""))

data <- assign_var_types(data, c("phase_str", "study_str", "id", "contingency", "ta"))
df <- data 
m7b1<-lmer(prob ~ contingency*phase_str + (1|id)  + (1|study_str), df)
m7b2<-lmer(prob ~ ta*contingency*phase_str + (1|id)  + (1|study_str), df)
m7b2b<-lmer(prob ~ ta*contingency*phase_str + (1|id)  + (1+ta+contingency+phase_str|study_str), df)
m7b3<-lmer(prob ~ tabin*contingency*phase_str + (1|id)  + (1|study_str), df)
#m7b4<-lmer(prob ~ tabin*contingency*phase_str*half_str + (1|id), df)
anova(m7b1, m7b2,m7b2b, m7b3)

anova(m7b2)

joint_tests(m7b2, by = "phase_str")
joint_tests(m7b2, by = "contingency")
joint_tests(m7b2, by = c("contingency", "phase_str"))

# marginals and tests without anxiety
em7b2 = emmeans(m7b2, specs = pairwise ~ phase_str*contingency)
em7b2$emmeans
em7b2$contrasts

em7b2a = emmeans(m7b3, specs = pairwise ~ tabin*phase_str*contingency)
em7b2a$emmeans

em7b2b = emmeans(m7b3, specs = pairwise ~ tabin*phase_str)
em7b2b$emmeans

em7b2b = emmeans(m7b2, specs = pairwise ~ phase_str)
em7b2b$emmeans

# relationship with anxiety
emtrends(m7b2, pairwise ~ phase_str, var = "ta")


theme_set(theme_sjplot())
plot_model(m7b2, type = "pred", terms = c("ta", "phase_str", "contingency"))

```

### c. differnce between stable and reversal ratings

```{r}
dst<-read.csv(paste(path_root, "/output/tables_and_csvs/prob_err_by_phase_STABLES_contingency.csv", sep=""))
dst <- assign_var_types(dst, c("trtype_str", "study_str", "id", "contingency", "ta"))
dst <- dst[ , !(names(dst) %in% c("err", "Trial_Type"))]
dst <- dst %>%
  pivot_wider(names_from = "trtype_str", values_from = "prob")
dst["stables_diff"] <- dst["hi-prob"] - dst["low-prob"]   



drev<-read.csv(paste(path_root, "/output/tables_and_csvs/prob_err_by_phase_REV_contingency.csv", sep=""))
drev <- assign_var_types(drev, c("phase_str", "study_str", "id", "contingency", "ta"))
drev <- drev[ , !(names(drev) %in% c("err", "study_str", "id","contingency", "ta"))]
drev <-drev %>%
  pivot_wider(names_from = "phase_str", values_from = "prob")
drev["rev_diff"] <- drev["acq"] - drev["ext"] 


df <- merge(dst, drev, by='specID')

atest <- df %>% 
  nest(-contingency)

df %>% 
  nest(-contingency) %>% 
  mutate(cor=map(data,~cor.test(.x$stables_diff, .x$rev_diff, method = "kendall"))) %>%
  mutate(tidied = map(cor, tidy)) %>% 
  unnest(tidied, .drop = T)
```
### c. Error: stable cues
```{r}
data<-read.csv(paste(path_root, "/output/tables_and_csvs/prob_err_by_phase_STABLES_contingency.csv", sep=""))

#data["tabin"]<-dicho(data$ta)
data$trtype_str = to_factor(data$trtype_str)
data$study_str = to_factor(data$study_str)
data$id = to_factor(data$id)
data$contingency = to_factor(data$contingency)
data$ta <- demean(data$ta)
df<-data


m7c1<-lmer(err ~ contingency*trtype_str + (1|id) , df)
m7c2<-lmer(err ~ ta*contingency*trtype_str + (1|id), df)
m7c3<-lmer(err ~ tabin*contingency*trtype_str + (1|id), df)
anova(m7c1, m7c2, m7c3)

anova(m7c2)

joint_tests(m7c2, by = "contingency")
joint_tests(m7c2, by = "trtype_str")

em7c3a = emmeans(m7c3, specs = pairwise ~ tabin*trtype_str)
em7c3a$emmeans

em7c3 = emmeans(m7c3, specs = pairwise ~ tabin*trtype_str*contingency)
em7c3$emmeans

# relationship with anxiety
emtrends(m7c2, pairwise ~ trtype_str:contingency, var = "ta")
emtrends(m7c2, pairwise ~ trtype_str, var = "ta")


theme_set(theme_sjplot())
plot_model(m7c2, type = "pred", terms = c("ta", "trtype_str", "contingency"))

```
### c2. Error - tests against 0

```{r}
data<-read.csv(paste(path_root, "/output/tables_and_csvs/prob_err_by_phase_STABLES_contingency.csv", sep=""))

vars <- c("contingency", "ta", "study")
data <- assign_var_types(data, vars)
data$id = to_factor(data$id)
df<-data



df2 <- df %>% 
    group_by(contingency, tabin, trtype_str) %>%
    nest() %>% 
    mutate(tt=map(data,~t.test(.x$err))) %>%
    mutate(tidied = map(tt, tidy)) %>% 
    unnest(tidied, .drop = T)
df2$p.value.fdr = p.adjust(df2$p.value, method = "fdr")
df2$p.value.tukey = p.adjust(df2$p.value, method = "fdr")

df2

```

### d. Error: reversal cue

```{r}
data<-read.csv(paste(path_root, "/output/tables_and_csvs/prob_err_by_phase_REV_contingency.csv", sep=""))
data$phase_str = to_factor(data$phase_str)
data$study_str = to_factor(data$study_str)
data$id = to_factor(data$id)
data$contingency = to_factor(data$contingency)

data$ta <- demean(data$ta)
df <- data 

m7d1<-lmer(err ~ contingency*phase_str + (1|id) , df)
m7d2<-lmer(err ~ ta*contingency*phase_str + (1|id) , df)
m7d3<-lmer(err ~ tabin*contingency*phase_str + (1|id) , df)
anova(m7d1, m7d2, m7d3)

anova(m7d2)

joint_tests(m7d2, by = "phase_str")
joint_tests(m7d2, by = "contingency")

# marginals and tests without anxiety
em7d2 = emmeans(m7d2, specs = pairwise ~ phase_str*contingency)
em7d2$emmeans

em7d3a = emmeans(m7d3, specs = pairwise ~ tabin*phase_str)
em7d3a$emmeans

em7d3 = emmeans(m7d3, specs = pairwise ~ tabin*phase_str*contingency)
em7d3$emmeans


# relationship with anxiety
emtrends(m7d2, pairwise ~ phase_str:contingency, var = "ta")


theme_set(theme_sjplot())
plot_model(m7d2, type = "pred", terms = c("ta", "phase_str", "contingency"))

```

### d2. Error - tests against 0

```{r}
data<-read.csv(paste(path_root, "/output/tables_and_csvs/prob_err_by_phase_REV_contingency.csv", sep=""))

vars <- c("contingency", "ta", "study", "phase_str")
data <- assign_var_types(data, vars)
data$id = to_factor(data$id)
df<-data

df2 <- df %>% 
    group_by(contingency, tabin, phase_str) %>%
    nest() %>% 
    mutate(tt=map(data,~t.test(.x$err))) %>%
    mutate(tidied = map(tt, tidy)) %>% 
    unnest(tidied, .drop = T)
df2$p.value.fdr = p.adjust(df2$p.value, method = "fdr")
df2$p.value.bonf = p.adjust(df2$p.value, method = "bonferroni")

df2

df = df %>%
  group_by(id, tabin, phase_str) %>%
  summarise_at(c("err"), mean, na.rm = TRUE)


df2 <- df %>% 
    group_by(tabin, phase_str) %>%
    nest() %>% 
    mutate(tt=map(data,~t.test(.x$err))) %>%
    mutate(tidied = map(tt, tidy)) %>% 
    unnest(tidied, .drop = T)
df2$p.value.fdr = p.adjust(df2$p.value, method = "fdr")
df2$p.value.bonf = p.adjust(df2$p.value, method = "bonferroni")

df2

```

### e. Probabilities in post-reversal 10 trials (rev cue only)



```{r}
data<-read.csv(paste(path_root, "/output/tables_and_csvs/full_REV_data.csv", sep=""))
data<-data[which(data$rev_trl %in% seq(10)),]
data["tabin"]<-dicho(data$ta)
data$tabin <- mapvalues(data$tabin,
                           from = c(0,1),
                           to = c("lowAnx", "hiAnx"))
data$rev_trl <- as.numeric(data$rev_trl)
data$phase_str = to_factor(data$phase_str)
data$contingency = to_factor(data$contingency)
data$ta <- demean(data$ta)
df<-data



emm_options(lmerTest.limit = 20000)
m7e1<-lmer(prob ~ rev_trl*contingency*phase_str + (1|id) + (1|study_str) , df)
m7e2<-lmer(prob ~ ta*rev_trl*contingency*phase_str + (1|id) + (1|study_str), df)
m7e3<-lmer(prob ~ tabin*rev_trl*contingency*phase_str + (1|id) + (1|study_str) , df)


anova(m7e2)

#extract radnom effects
d<-ranef(m7e2)

#joint_tests(m7e2, by = "phase_str")
#joint_tests(m7e2, by = c("contingency", "phase_str"))

# marginals and tests without anxiety
#em7e2 = emmeans(m7e2, specs = pairwise ~ phase_str*rev_trl)
#em7e2$emmeans

# relationship with anxiety
#emtrends(m7e3, pairwise ~ tabin:phase_str:contingency, var = "rev_trl")


theme_set(theme_sjplot())
#plot_model(m7e3, type = "pred", terms = c( "rev_trl", "tabin", "phase_str", "contingency"), show.data = TRUE, colors=c("springgreen4", "hotpink"))

```
##### raincloud theme
```{r}
raincloud_theme = theme(
text = element_text(size = 10),
axis.title.x = element_text(size = 16),
axis.title.y = element_text(size = 16),
axis.text = element_text(size = 14),
axis.text.x = element_text(angle = 0, vjust = 0.5),
legend.title=element_text(size=16),
legend.text=element_text(size=16),
legend.position = "right",
plot.title = element_text(lineheight=.8, face="bold", size = 16),
panel.border = element_blank(),
panel.grid.minor = element_blank(),
panel.grid.major = element_blank(),
axis.line.x = element_line(colour = 'black', size=0.5, linetype='solid'),
axis.line.y = element_line(colour = 'black', size=0.5, linetype='solid'))

```
#### e2. Coefficients separate for acq and ext
```{r}
df <- data[,c("id", "ta")]
df<-df[!duplicated(df$id),]
df["tabin"]<-dicho(df$ta)
df$tabin <- mapvalues(df$tabin,
                           from = c(0,1),
                           to = c("lowAnx", "hiAnx"))
df["tabin"]<-to_factor(df["tabin"])
adata <- data[which(data$Learning_Phase %in% c(1)),]
m7e2_1 = lmer(prob ~ contingency + (rev_trl|id) , adata)
rn_a<- data.frame(ranef(m7e2_1))
rn_a["id"] <- rn_a$grp
df_a <- merge(df, rn_a[rn_a$term=="rev_trl",], by="id")
df_a["phase"] <- "acq"

edata <- data[which(data$Learning_Phase %in% c(2)),]
m7e2_2 = lmer(prob ~ contingency + (rev_trl|id) , edata)
rn_e<- data.frame(ranef(m7e2_2))
rn_e["id"] <- rn_e$grp
df_e <- merge(df, rn_e[rn_e$term=="rev_trl",], by="id")
df_e["phase"] <- "ext"

dt <- rbind(df_a, df_e)

## fitting all at once#######################3
m <- lmer(prob ~ 1 + (rev_trl|phase_str/contingency/id) , data)
d<-ranef(m)
d<-data.frame(d$`id:(contingency:phase_str)`)
colnames(d) <- c("condval", "sd")
conds<- t(data.frame(strsplit(rownames(d), ":")))
colnames(conds)<- c("id", "contingency", "phase")
m2d<-merge( df, cbind(d,conds), by="id")
######################



g <- ggplot(data = dt, aes(y = condval, x = phase, fill = tabin, color = tabin)) +
geom_flat_violin(position = position_nudge(x = .2, y = 0), alpha = .8) +
geom_point(aes(y = condval), position = position_jitter(width = .15), size = 1, alpha = 0.5) +
geom_boxplot(width = .2, outlier.shape = NA, alpha = 0.7) +

expand_limits(x = 3) +
#scale_color_manual(values = cols) +
#scale_fill_manual(values = cols) +
# coord_flip() +
theme_bw() +
raincloud_theme +
  labs(y= "Slope on trials 1 - 10") 
g
ggsave(paste(figpath, "phase_slopes.png", sep=""), width = 5, height = 4, dpi = 120)
```
#### e3. Probabilities in post-reversal 10 trials split by early/late (rev cue only)

```{r}

data<-read.csv(paste(path_root, "/output/tables_and_csvs/full_REV_data.csv", sep=""))
data<-data[which(data$rev_trl %in% seq(10)),]
data["tabin"]<-dicho(data$ta)
data$tabin <- mapvalues(data$tabin,
                           from = c(0,1),
                           to = c("lowAnx", "hiAnx"))
data$rev_trl <- as.numeric(data$rev_trl)
data$phase_str = to_factor(data$phase_str)
data$contingency = to_factor(data$contingency)
data$half_str = to_factor(data$half_str)
data$ta <- demean(data$ta)
df<-data
emm_options(lmerTest.limit = 20000)
m7e0<-lmer(prob ~ ta*rev_trl*contingency*phase_str + (rev_trl|id) , df) # without half
m7e1<-lmer(prob ~ rev_trl*contingency*phase_str*half_str + (rev_trl|id) , df)
m7e2<-lmer(prob ~ ta*rev_trl*contingency*phase_str*half_str + (rev_trl|id) , df)
m7e3<-lmer(prob ~ tabin*rev_trl*contingency*phase_str*half_str + (rev_trl|id) , df)

anova(m7e0, m7e1, m7e2, m7e3)
## half does contribute meaningfully 
anova(m7e2)

joint_tests(m7e2, by = c("contingency", "phase_str"))

# marginals and tests without anxiety
#means(m7e2, specs = pairwise ~ ta*rev_trl*half_str*phase_str*contingency)
#em7e2$contrasts
# relationship with anxiety
#emtr_e7 <- emtrends(m7e3, pairwise ~ tabin:phase_str:contingency:half_str, var = "rev_trl")
#emtrends(mod, pairwise ~ temp, var="nitro", at=list(variety="A", temp=c(20,40))


theme_set(theme_sjplot())
plot_model(m7e2, type = "pred", terms = c( "rev_trl", "half_str","phase_str"), colors=c("springgreen4", "hotpink"))
plot_model(m7e2, type = "pred", terms = c("half_str"), colors=c("springgreen4", "hotpink"))
plot_model(m7e2, type = "pred", terms = c("contingency", "half_str"), colors=c("springgreen4", "hotpink"))



conts <- c("60/40", "75/25", "90/10")
phases <- c("acq", "ext")
halves <- c("first", "second")


df <- data[,c("id", "ta")]
df<-df[!duplicated(df$id),]
df["tabin"]<-dicho(df$ta)
df$tabin <- mapvalues(df$tabin,
                           from = c(0,1),
                           to = c("lowAnx", "hiAnx"))
df["tabin"]<-to_factor(df["tabin"])
dt <- data.frame()
for (c in conts) {
  for (ph in phases) {
    for (h in halves)  {
      adata <- data[which((data$phase_str %in% ph) & (data$contingency %in% c) & (data$half_str %in% h)),]
      print(mean(adata$prob))
      mm = lmer(prob ~ 1 + (rev_trl|id) , adata)
      rn_a<- data.frame(ranef(mm))
      rn_a["id"] <- rn_a$grp
      df_a<-data.frame()
      df_a <- merge(df, rn_a[rn_a$term=="rev_trl",], by="id")
      df_a["phase"] <- ph
      df_a["contingency"] <- c
      df_a["half"] <- h
      dt <- rbind(dt, df_a)
    }
  }
  
}

dt$phase_str = to_factor(dt$phase)
dt$contingency = to_factor(dt$contingency)
dt$half_str = to_factor(dt$half)

m7e4<-lmer(condval ~ ta*contingency*phase_str + (1|grp) , dt)
m7e4b<-lmer(condval ~ tabin*contingency*phase_str + (1|grp) , dt)
joint_tests(m7e4, by=c("contingency", "phase_str"))
joint_tests(m7e4, by=c("phase_str"))

joint_tests(m7e4, by=c("contingency"))
anova(m7e4)
em7e4 = emmeans(m7e4, specs = pairwise ~ phase_str*contingency)
em7e4$emmeans
em7e4$contrasts
em7e4b= emmeans(m7e4, specs = pairwise ~ phase_str)
em7e4b$emmeans
em7e4c = emmeans(m7e4b, specs = pairwise ~ tabin*phase_str*contingency)
em7e4c$emmeans
em7e4d = emmeans(m7e4b, specs = pairwise ~ tabin*phase_str)
em7e4d$emmeans


# relationship with anxiety
em7d2tr<-emtrends(m7d2, pairwise ~ phase_str:contingency, var = "ta")
#em7d2tr$contrasts

theme_set(theme_sjplot())
plot_model(m7e4, type = "pred", terms = c( "ta","phase_str"), colors=c("springgreen4", "hotpink"))
plot_model(m7e4, type = "pred", terms = c( "contingency","phase_str"), colors=c("springgreen4", "hotpink"))
#plot_model(m7e4, type = "pred", terms = c( "half_str","phase_str"), colors=c("springgreen4", "hotpink"))


pal <- get_colors("ond")
g <- ggplot(data = dt, aes(y = condval, x = phase, fill = tabin)) +
geom_flat_violin(position = position_nudge(x = .2, y = 0), alpha = .8,lwd=1.2) +
geom_point(aes(y = condval), position = position_jitter(width = .15), size = 1, alpha = 0.5) +
geom_boxplot(width = .2, outlier.shape = NA, alpha = 0.7, lwd=1.2) +
geom_hline(yintercept=c(0), linetype="dashed") +
expand_limits(x = 3) +
scale_color_manual(values = c(rgb(0.8,0.8,0.8), rgb(0.2,0.2,0.2))) +
scale_fill_manual(values = c(rgb(0.8,0.8,0.8), rgb(0.2,0.2,0.2)), name = "Trait anxiety", labels = c("Low", "High")) +
# coord_flip() +

theme_bw() +
raincloud_theme +
theme(strip.text.x = element_text(size = 14,  face = "bold"),
    strip.background = element_rect(color="black", fill="#ebebeb", size=0, linetype="solid")) +
labs(y= "Slope on trials 1 - 10", x="State") + 
scale_x_discrete(labels=c("acq" = "High", "ext" =  "Low")) +
facet_grid(cols=vars(contingency)) 
g
ggsave(paste(figpath, "slope.pdf", sep=""), width = 10, height = 3, dpi = 120)

dt$slope <- dt$condval
```

#### f. 1-10trials with autocorrelation 


library(nlme)
data<-read.csv(paste(path_root, "/output/tables_and_csvs/full_REV_data.csv", sep=""))
data<-data[which(data$rev_trl %in% seq(10)),]
#data["tabin"]<-dicho(data$ta)
data$phase_str = to_factor(data$phase_str)
data$ta <- demean(data$ta)
df<-data
emm_options(lmerTest.limit = 10000)
m7f1<-lme(prob ~ rev_trl*contingency*phase_str, random= ~ 1|id , data=df)
m7f1<-lme(prob ~ rev_trl*contingency*phase_str, random= ~ 1|id , data=df, correlation = corAR1(form = ~ rev_trl | id))
m7f1
anova(m7f1)

### slope and relative model fit 

```{r}
### assumes previous dt
data<-read.csv(paste(path_root, "output/tables_and_csvs/model_fit_final_full.csv", sep=""))
data<-assign_var_types(data, c("contingency", "ta", "study", "ids")) 
data$id <- data$ids
dt$slope <- abs(dt$slope)
dt2 = dt %>%
  group_by(id, contingency) %>%
  summarise_at(c("slope"), mean, na.rm = TRUE)

df <- join(x=as.data.frame(dt2[,c("contingency", "slope", "id")]), y=as.data.frame(data[, c("contingency", "id", "m1m3_diff", "ta")]), by=c("contingency", "id"))
df$slope_dm <- df$slope - mean(df$slope)
m<-lmer(data=df, m1m3_diff ~ contingency*slope_dm + (1|id))
anova(m)
mcon <- emtrends(m, var = "slope_dm")


  
g <- ggplot(data = df, aes(x = m1m3_diff, y = slope, color=slope )) +
geom_point( size = 3, alpha = 0.9, show.legend = FALSE) +
geom_smooth(method='lm', formula= y~x, alpha=0.3, show.legend = FALSE, color="black") +
#scale_color_gradient(low=col, high=col) +
theme_bw() +
raincloud_theme +
  stat_cor(method = "pearson",  alternative = "two.sided",  cor.coef.name = c("r"),  label.sep = ", ",  label.x.npc = "left",  label.y.npc = "top", digits = 3, r.digits = 3, p.digits = 3) + 
  labs(x= "relative model fit", y="slope")  + 
  facet_grid(cols=vars(contingency))
g
slope<-df

df2 = df %>%
  group_by(id, m1m3_diff) %>%
  summarise_at(c("slope"), mean, na.rm = TRUE)
g <- ggplot(data = df2, aes(x = m1m3_diff, y = slope, color=(slope) )) +
geom_point( size = 3, alpha = 0.9, show.legend = FALSE) +
geom_smooth(method='lm', formula= y~x, alpha=0.3, show.legend = FALSE, color="black") +
#scale_color_gradient(low=col, high=col) +
theme_bw() +
raincloud_theme +
  xlim(-100, 100) +
  stat_cor(method = "pearson",  alternative = "two.sided",  cor.coef.name = c("r"),  label.sep = ", ",  label.x.npc = "left",  label.y.npc = "top", digits = 3, r.digits = 3, p.digits = 3) + 
  labs(x= "relative model fit", y="slope") 
g

g <- ggplot(data = df, aes(x = ta, y = slope, color=(slope) )) +
geom_point( size = 3, alpha = 0.9, show.legend = FALSE) +
geom_smooth(method='lm', formula= y~x, alpha=0.3, show.legend = FALSE, color="black") +
#scale_color_gradient(low=col, high=col) +
theme_bw() +
raincloud_theme +
  stat_cor(method = "pearson",  alternative = "two.sided",  cor.coef.name = c("r"),  label.sep = ", ",  label.x.npc = "left",  label.y.npc = "top", digits = 3, r.digits = 3, p.digits = 3) + 
  labs(x= "anxiety", y="slope")  + 
  facet_grid(cols=vars(contingency))
g

```


## 8. Switchpoint and steepness data
### a. steepness

```{r}
data<-read.csv(paste(path_root, "/output/tables_and_csvs/steepness_and_switchpoint_full.csv", sep=""))
data<-assign_var_types(data, c("study", "ta", "phase_str", "half_str", "cont", "tabin", "session"))

data2 = data %>%
  group_by(id, cont,phase_str, ta, study_str) %>%
  summarise_at(c("log_steepness", "steepness"), mean, na.rm = TRUE)

m8a <- lmer(log_steepness ~ ta*cont*phase_str + (1|id) + (1|study_str) , data2)

anova(m8a)

joint_tests(m8a, by = "cont")

# marginals and tests without anxiety
em8a = emmeans(m8a, specs = pairwise ~ cont)
em8a$emmeans
em8a$contrasts

# relationship with anxiety
emtrends(m8a, pairwise ~ cont, var = "ta")

theme_set(theme_sjplot())

pal <- get_colors("ond")


g <- ggplot(aes(x=cont, y=log_steepness, fill=cont), data=data2) + 
  geom_flat_violin(position = position_nudge(x = .2, y = 0), alpha = .8) +
  geom_point(aes(y = log_steepness, color=cont), position = position_jitter(width = .15), size = 1, alpha = 0.5, show.legend = FALSE) +
  geom_boxplot(width = .2, outlier.shape = NA, alpha = 0.7, show.legend = FALSE) +
  
  expand_limits(x = 3) +
  scale_color_brewer(palette="RdPu",name="Session") +
  scale_fill_brewer(palette="RdPu",name="Session") +
  # coord_flip() +
  theme_bw() +
  raincloud_theme +
    labs(y= "Estimated (log) Steepness", x="Session") 
  g
  #geom_smooth(method='lm', formula= y~x) +
  #cale_fill_manual(values = c(pal[10], pal[6], pal[2], pal[4])) +
  #acet_grid(cols=vars(cont)) 

```

### a. switchpoint

```{r}
data<-read.csv(paste(path_root, "/output/tables_and_csvs/steepness_and_switchpoint_full.csv", sep=""))
data<-assign_var_types(data, c("study", "ta", "phase_str", "half_str", "cont", "tabin", "session"))

data2 = data %>%
  group_by(id, cont, ta, tabin, study_str) %>%
  summarise_at(c("switchpoint"), mean, na.rm = TRUE)

data3a= data %>%
  group_by( cont) %>%
  summarise_at(c("switchpoint"), mean, na.rm = TRUE)
data3= data %>%
  group_by( cont,  tabin) %>%
  summarise_at(c("switchpoint"), mean, na.rm = TRUE)


m8b <- lmer(switchpoint ~ ta*cont + (1|id) + (1|study_str) , data2)
#m8c <- lmer(switchpoint ~ tabin*phase_str*cont + (1|id) + (1|study_str) , data2)
#summary(m8b)
anova(m8b)

joint_tests(m8b, by = "cont")

# marginals and tests without anxiety
em8b = emmeans(m8b, specs = pairwise ~ cont)
em8b$emmeans
em8b$contrasts

em8c = emmeans(m8c, specs = pairwise ~ cont*tabin)
em8c$emmeans
em8c$contrasts

# relationship with anxiety
emtrends(m8b, pairwise ~ cont, var = "ta")

theme_set(theme_sjplot())

pal <- get_colors("ond")


g <- ggplot(aes(x=cont, y=switchpoint, fill=cont), data=data2) + 
  geom_flat_violin(position = position_nudge(x = .2, y = 0), alpha = .8) +
  geom_point(aes(y = switchpoint), position = position_jitter(width = .15), size = 1, alpha = 0.5, show.legend = FALSE) +
  geom_boxplot(width = .2, outlier.shape = NA, alpha = 0.7, show.legend = FALSE) +
  
  expand_limits(x = 3) +
  #scale_color_manual(values = cols) +
  scale_fill_brewer(palette="Blues") +
  # coord_flip() +
  theme_bw() +
  raincloud_theme +
    labs(y= "Estimated Switchpoint", x="Session") 
  g
  #geom_smooth(method='lm', formula= y~x) +
  #cale_fill_manual(values = c(pal[10], pal[6], pal[2], pal[4])) +
  #acet_grid(cols=vars(cont)) 

```
### switchpoint by best model and anxiety

```{r}
data<-read.csv(paste(path_root, "/output/tables_and_csvs/steepness_and_switchpoint_full.csv", sep=""))
data<-assign_var_types(data, c("study", "ta", "phase_str", "half_str", "cont", "tabin", "session"))
data$contingency <- data$cont
data<-data[data$phase_str %in% c("acq", "ext"),]
data2 = data %>%
  group_by(id, contingency, ta, tabin, study_str) %>%
  summarise_at(c("log_steepness"), mean, na.rm = TRUE)

mdata<-read.csv(paste(path_root, "output/tables_and_csvs/model_fit_final_full.csv", sep=""))
mdata<-assign_var_types(mdata, c("contingency", "ta", "study", "ids", "ta_orig_scale"))  
mdata["best_model"] <- apply(mdata[,c("m1_BIC", "m3_BIC")], 1, which.min)
mdata$best_model <- mapvalues(mdata$best_model,
                            from = c(1,2),
                            to =c("1-state", "n-state"))
mdata$id <- mdata$ids
df <- join(as.data.frame(data2[,c("id", "contingency", "log_steepness")]), as.data.frame(mdata[,c("id", "contingency", "best_model", "m1m3_diff", "ta", "ta_orig_scale")]), by=c("id", "contingency"))
steep<-df

m8d <- lmer(log_steepness ~ contingency*m1m3_diff + (1|id) , df)

#summary(m8b)
anova(m8d)

g <- ggplot(data = df, aes(x = log_steepness, y = m1m3_diff, color=(m1m3_diff) )) +
geom_point( size = 3, alpha = 0.9, show.legend = FALSE) +
geom_smooth(method='lm', formula= y~x, alpha=0.3, show.legend = FALSE, color="black") +
#scale_color_gradient(low=col, high=col) +
theme_bw() +
raincloud_theme +
  stat_cor(method = "pearson",  alternative = "two.sided",  cor.coef.name = c("r"),  label.sep = ", ",  label.x.npc = "left",  label.y.npc = "top", digits = 3, r.digits = 3, p.digits = 3) + 
  labs(x= "steepness", y="relative model fit")  + 
  facet_grid(cols=vars(contingency))
g

g <- ggplot(data = df, aes(x = log_steepness, y = ta, color=(ta) )) +
geom_point( size = 3, alpha = 0.9, show.legend = FALSE) +
geom_smooth(method='lm', formula= y~x, alpha=0.3, show.legend = FALSE, color="black") +
#scale_color_gradient(low=col, high=col) +
theme_bw() +
raincloud_theme +
  stat_cor(method = "kendall",  alternative = "two.sided",  cor.coef.name = c("r"),  label.sep = ", ",  label.x.npc = "left",  label.y.npc = "top", digits = 3, r.digits = 3, p.digits = 3) + 
  labs(x= "log_steepness", y="ta")  + 
  facet_grid(cols=vars(contingency))
g



```

### Link slope and steepness together

```{r}
df <- merge(slope, steep)
g <- ggplot(data = df, aes(x = log_steepness, y = slope, color=(slope) )) +
geom_point( size = 3, alpha = 0.9, show.legend = FALSE) +
geom_smooth(method='lm', formula= y~x, alpha=0.3, show.legend = FALSE, color="black") +
#scale_color_gradient(low=col, high=col) +
theme_bw() +
raincloud_theme +
  stat_cor(method = "pearson",  alternative = "two.sided",  cor.coef.name = c("r"),  label.sep = ", ",  label.x.npc = "left",  label.y.npc = "top", digits = 3, r.digits = 3, p.digits = 3) + 
  labs(x= "log_steepness", y="slope")  + 
  facet_grid(cols=vars(contingency))
g


df2 = df %>%
  group_by(id, ta_orig_scale) %>%
  summarise_at(c("log_steepness", "slope"), mean, na.rm = TRUE)
g <- ggplot(data = df2, aes(x = log_steepness, y = slope, color=(slope) )) +
geom_point( size = 3, alpha = 0.9, show.legend = FALSE) +
geom_smooth(method='lm', formula= y~x, alpha=0.3, show.legend = FALSE, color="black") +
#scale_color_gradient(low=col, high=col) +
theme_bw() +
raincloud_theme +
  stat_cor(method = "pearson",  alternative = "two.sided",  cor.coef.name = c("r"),  label.sep = ", ",  label.x.npc = "left",  label.y.npc = "top", digits = 3, r.digits = 3, p.digits = 3) + 
  labs(x= "log_steepness", y="slope") 
g


g1 <- ggplot(data = df2, aes(x = ta_orig_scale, y = slope, color=(slope) )) +
geom_point( size = 3, alpha = 0.9, show.legend = FALSE) +
geom_smooth(method='lm', formula= y~x, alpha=0.3, show.legend = FALSE, color="black") +
scale_color_gradient(low="darkslategray3", high="lightskyblue4") +
theme_bw() +
raincloud_theme +
 # stat_cor(method = "pearson",  alternative = "two.sided",  cor.coef.name = c("r"),  label.sep = ", ",  label.x.npc = "left",  label.y.npc = "top", digits = 3, r.digits = 3, p.digits = 3) + 
  labs(x= "", y="Slope") 

g2 <- ggplot(data = df2, aes(x = ta_orig_scale, y = log_steepness, color=(log_steepness) )) +
geom_point( size = 3, alpha = 0.9, show.legend = FALSE) +
geom_smooth(method='lm', formula= y~x, alpha=0.3, show.legend = FALSE, color="black") +
scale_color_gradient(low="darkslategray3", high="lightskyblue4") +
theme_bw() +
raincloud_theme +
 # stat_cor(method = "pearson",  alternative = "two.sided",  cor.coef.name = c("r"),  label.sep = ", ",  label.x.npc = "left",  label.y.npc = "top", digits = 3, r.digits = 3, p.digits = 3) + 
  labs(x= "Trait anxiety", y="Log steepness") 
library(patchwork)
(g1/g2)

ggsave(paste(pubfigpath, "Figure_switchpoint/steepness_slope.pdf", sep=""), width = 4, height =6, dpi = 120)

```

### switchpoint by best model and anxiety

```{r}
data<-read.csv(paste(path_root, "/output/tables_and_csvs/steepness_and_switchpoint_full.csv", sep=""))
data<-assign_var_types(data, c("study", "ta", "phase_str", "half_str", "cont", "tabin", "session"))
data$contingency <- data$cont
data2 = data %>%
  group_by(id, contingency,phase_str, ta, tabin, study_str) %>%
  summarise_at(c("switchpoint"), mean, na.rm = TRUE)

mdata<-read.csv(paste(path_root, "output/tables_and_csvs/model_fit_final_full.csv", sep=""))
mdata<-assign_var_types(mdata, c("contingency", "ta", "study", "ids"))  
mdata["best_model"] <- apply(mdata[,c("m1_BIC", "m3_BIC")], 1, which.min)
mdata$best_model <- mapvalues(mdata$best_model,
                            from = c(1,2),
                            to =c("1-state", "n-state"))
mdata$id <- mdata$ids
df <- join(as.data.frame(data2[,c("id", "contingency", "switchpoint")]), as.data.frame(mdata[,c("id", "contingency", "best_model", "m1m3_diff", "ta")]), by=c("id", "contingency"))

m8d <- lmer(switchpoint ~ contingency*m1m3_diff + (1|id) , df)

#summary(m8b)
anova(m8d)

g <- ggplot(data = df, aes(x = switchpoint, y = m1m3_diff, color=m1m3_diff )) +
geom_point( size = 3, alpha = 0.9, show.legend = FALSE) +
geom_smooth(method='lm', formula= y~x, alpha=0.3, show.legend = FALSE, color="black") +
scale_color_gradient(low="blue", high="blue") +
theme_bw() +
raincloud_theme +
  stat_cor(method = "pearson",  alternative = "two.sided",  cor.coef.name = c("r"),  label.sep = ", ",  label.x.npc = "left",  label.y.npc = "top", digits = 3, r.digits = 3, p.digits = 3) + 
  labs(x= "switchpoint", y="relative model fit")  + 
  facet_grid(cols=vars(contingency))
g

g <- ggplot(data = df, aes(x = switchpoint, y = ta, color=(ta) )) +
geom_point( size = 3, alpha = 0.9, show.legend = FALSE) +
geom_smooth(method='lm', formula= y~x, alpha=0.3, show.legend = FALSE, color="black") +
scale_color_gradient(low="blue", high="blue") +
theme_bw() +
raincloud_theme +
  stat_cor(method = "pearson",  alternative = "two.sided",  cor.coef.name = c("r"),  label.sep = ", ",  label.x.npc = "left",  label.y.npc = "top", digits = 3, r.digits = 3, p.digits = 3) + 
  labs(x= "switchpoint", y="ta")  + 
  facet_grid(cols=vars(contingency))
g



```

## 9. Model fit data 


### a1. model fit - all three models 
```{r}
data<-read.csv(paste(path_root, "output/tables_and_csvs/model_fit_final_full.csv", sep=""))

data<-assign_var_types(data, c("contingency", "ta", "study", "ids"))  

data %>%
  group_by(contingency) %>%
  summarise_at(c("m1_BIC", "m2_BIC", "m3_BIC"), mean, na.rm = TRUE)

data["best_model"] <- apply(data[,c("m1_BIC", "m2_BIC", "m3_BIC")], 1, which.min)
data$best_model <- mapvalues(data$best_model,
                            from = c(1,2,3),
                            to =c("1-state", "2-state", "n-state"))

df <- data %>% 
     melt(id.vars = c("ids", "contingency"),  # variables to carry forward
          measure.vars = c("m1_BIC", "m2_BIC", "m3_BIC"),  #variables to stack
          value.name = "BIC",     # name of the value variable 
          variable.name = "model" ) # name of the variable 
df$model <- mapvalues(df$model,
                            from = c("m1_BIC", "m2_BIC", "m3_BIC"),
                            to =c("1-state", "2-state", "n-state"))

pal <- get_colors("ond")

df2 = df %>%
  group_by(model, contingency ) %>%
  summarise_at("BIC", mean, na.rm = TRUE, label = mean(BIC))
  df2$BIC = round(df2$BIC,2)

g <- ggplot(aes(x=model, y=BIC, fill=model), data=df) + 
  geom_flat_violin(position = position_nudge(x = .2, y = 0), alpha = .8) +
  geom_point(aes(y = BIC), position = position_jitter(width = .15), size = 1, alpha = 0.5, show.legend = FALSE) +
  geom_boxplot(width = .2, outlier.shape = NA, alpha = 0.7, show.legend = FALSE) +
  geom_label(data = df2, aes(label = BIC, x = model, y = 0),  size=5, show.legend = FALSE) +

            
  expand_limits(x = 3) +
  #scale_color_manual(values = cols) +
  scale_fill_manual(values = c(pal[17], pal[2], pal[6])) +
  # coord_flip() +
  theme_bw() +
  raincloud_theme +
  theme(legend.position="top") +
    labs(y= "BIC", x="model") +
  facet_grid(cols=vars(contingency))
  g
  
  
  library(extdplyr)
data %>% 
  group_by (contingency, best_model) %>%
  pct_routine(ret_name = "pct")

g <- ggplot(data, aes(best_model, group = contingency, fill=best_model)) + 
          geom_bar(aes(y = ..prop.., fill = factor(..x..)), stat="count", show.legend = FALSE) + 
          scale_y_continuous(labels=scales::percent) +
          scale_fill_manual(values = c(pal[17], pal[2], pal[6])) +
          labs(y= "% best fitted", x="")  +

          facet_grid(~contingency)
g

```
### a1. model fit - 1-state vs 2-state

```{r}

data<-read.csv(paste(path_root, "output/tables_and_csvs/model_fit_final_full.csv", sep=""))

data<-assign_var_types(data, c("contingency", "ta", "study", "ids"))  

data %>%
  group_by(contingency) %>%
  summarise_at(c("m1_BIC", "m2_BIC"), mean, na.rm = TRUE)

data["best_model"] <- apply(data[,c("m1_BIC", "m2_BIC")], 1, which.min)
data$best_model <- mapvalues(data$best_model,
                            from = c(1,2),
                            to =c("1-state", "2-state"))

df <- data %>% 
     melt(id.vars = c("ids", "contingency"),  # variables to carry forward
          measure.vars = c("m1_BIC", "m2_BIC"),  #variables to stack
          value.name = "BIC",     # name of the value variable 
          variable.name = "model" ) # name of the variable 
df$model <- mapvalues(df$model,
                            from = c("m1_BIC", "m2_BIC"),
                            to =c("1-state", "2-state"))

pal <- get_colors("ond")

df2 = df %>%
  group_by(model, contingency ) %>%
  summarise_at("BIC", mean, na.rm = TRUE, label = mean(BIC))
  df2$BIC = round(df2$BIC,2)

g <- ggplot(aes(x=model, y=BIC, fill=model), data=df) + 
  geom_flat_violin(position = position_nudge(x = .2, y = 0), alpha = .8) +
  geom_point(aes(y = BIC), position = position_jitter(width = .15), size = 1, alpha = 0.5, show.legend = FALSE) +
  geom_boxplot(width = .2, outlier.shape = NA, alpha = 0.7, show.legend = FALSE) +
  geom_label(data = df2, aes(label = BIC, x = model, y = 0),  size=5, show.legend = FALSE) +

  
  expand_limits(x = 3) +
  #scale_color_manual(values = cols) +
  scale_fill_manual(values = c(pal[17], pal[2], pal[6])) +
  # coord_flip() +
  theme_bw() +
  raincloud_theme +
    labs(y= "BIC", x="model") +
  facet_grid(cols=vars(contingency))
  g
  
  
  library(extdplyr)
data %>% 
  group_by (contingency, best_model) %>%
  pct_routine(ret_name = "pct")

g <- ggplot(data, aes(best_model, group = contingency, fill=best_model)) + 
          geom_bar(aes(y = ..prop.., fill = factor(..x..)), stat="count", show.legend = FALSE) + 
          scale_y_continuous(labels=scales::percent) +
          labs(y= "% best fitted", x="")  +
        scale_fill_manual(values = c(pal[17], pal[2], pal[6])) +
          facet_grid(~contingency)
g

```
### a1. model fit - 1-state vs n-state 
```{r}
data<-read.csv(paste(path_root, "output/tables_and_csvs/model_fit_final_full.csv", sep=""))

data<-assign_var_types(data, c("contingency", "ta", "study", "ids"))  

data %>%
  group_by(contingency) %>%
  summarise_at(c("m1_BIC", "m3_BIC"), mean, na.rm = TRUE)

data["best_model"] <- apply(data[,c("m1_BIC", "m3_BIC")], 1, which.min)
data$best_model <- mapvalues(data$best_model,
                            from = c(1,2),
                            to =c("1-state", "n-state"))

df <- data %>% 
     melt(id.vars = c("ids", "contingency"),  # variables to carry forward
          measure.vars = c("m1_BIC", "m3_BIC"),  #variables to stack
          value.name = "BIC",     # name of the value variable 
          variable.name = "model" ) # name of the variable 
df$model <- mapvalues(df$model,
                            from = c("m1_BIC",  "m3_BIC"),
                            to =c("1-state",  "n-state"))

pal <- get_colors("ond")

df2 = df %>%
  group_by(model, contingency ) %>%
  summarise_at("BIC", mean, na.rm = TRUE, label = mean(BIC))
  df2$BIC = round(df2$BIC,2)
df3 = df %>%
  group_by(model) %>%
  summarise_at("BIC", mean, na.rm = TRUE)


g <- ggplot(aes(x=model, y=BIC, fill=model), data=df) + 
  geom_flat_violin(position = position_nudge(x = .2, y = 0), alpha = .8) +
  geom_point(aes(y = BIC), position = position_jitter(width = .15), size = 1, alpha = 0.5, show.legend = FALSE) +
  geom_boxplot(width = .2, outlier.shape = NA, alpha = 0.7, show.legend = FALSE) +
  geom_label(data = df2, aes(label = BIC, x = model, y = 0),  size=5, show.legend = FALSE) +

  
  expand_limits(x = 3) +
  #scale_color_manual(values = cols) +
  scale_fill_manual(values = c(pal[2], pal[6])) +
  # coord_flip() +
  theme_bw() +
  raincloud_theme +
    labs(y= "BIC", x="model") +
  facet_grid(cols=vars(contingency))
  g
  
  
  library(extdplyr)
data %>% 
  group_by (contingency, best_model) %>%
  pct_routine(ret_name = "pct")

data %>% 
  group_by ( best_model) %>%
  pct_routine(ret_name = "pct")

g <- ggplot(data, aes(best_model, group = contingency, fill=model)) + 
          geom_bar(aes(y = ..prop.., fill = factor(..x..)), stat="count", show.legend = FALSE) + 
          scale_y_continuous(labels=scales::percent) +
          scale_fill_manual(values = c(pal[2], pal[6])) +
          labs(y= "% best fitted", x="")  +
          facet_grid(~contingency)
g

```

### a2. model fits - demeaned AIC 

```{r}
data<-read.csv(paste(path_root, "/output/tables_and_csvs/model_fit_final_full.csv", sep=""))
data$ta <- as.numeric(demean(data$ta))
data["tabin"]<-dicho(data$ta)
data$contingency = to_factor(data$contingency)
data$tabin <- mapvalues(data$tabin,
                           from = c(0,1),
                           to = c("lowAnx", "hiAnx"))
library(tidyr)
df = data %>%
  group_by(ids,contingency,ta) %>%
  summarise_at(c("m1_BIC","m3_BIC"), mean, na.rm = TRUE)
df2 <- df %>% gather(model, BIC, m1_BIC:m3_BIC)
#df2$BIC <- as.numeric(demean(df2$BIC))
pal <- get_colors("ond")

df_summ1 = df2 %>%
  group_by(model) %>%
  summarise_each(funs(mean,sd,se=sd(.)/sqrt(n())), BIC)
print(df_summ1)

df_summ1 = df2 %>%
  group_by(model, contingency) %>%
  summarise_each(funs(mean,sd,se=sd(.)/sqrt(n())), BIC)
print(df_summ1)


#demean per session 
dem_df <- df2 %>%
  group_by(contingency) %>%
  summarise_at(c("BIC"), mean, na.rm = TRUE)
dem_df$BICmean <- dem_df$BIC
dem_df$BIC <- NaN
df2<- merge(x = df2, y = dem_df, by = "contingency", all.x = TRUE)
df2$BIC_demean <- df2$BIC.x - df2$BICmean

df_summ = df2 %>%
  group_by(model, contingency) %>%
  summarise_each(funs(mean,sd,se=sd(.)/sqrt(n())), BIC_demean)
print(df_summ)

```

### a. model fit - raleative
```{r}
#data<-read.csv(paste(path_root, "/output/tables_and_csvs/model_fit_data.csv", sep=""))
#data<-read.csv(paste(path_root, "/output/tables_and_csvs/model_fit_from_phase_1_to_end_bsim-fx_v1.csv", sep=""))
#data<-read.csv(paste(path_root, "/output/tables_and_csvs/model_fit_from_phase_1_to_end.csv", sep=""))
 data<-read.csv(paste(path_root, "output/tables_and_csvs/model_fit_final_full.csv", sep=""))

data<-assign_var_types(data, c("contingency", "ta", "study", "ids", "order"))  



#m9a <- rlmer(m1m3_diff ~ ta*contingency + (1|ids) , data)
m9a <- lmer(m1m3_diff ~ ta*contingency + (1|ids) + (1|study_str) , data)
anova(m9a)

joint_tests(m9a, by = "contingency")

# marginals and tests without anxiety
em9a = emmeans(m9a, specs = pairwise ~ contingency)
em9a$emmeans
em9a$contrasts

# relationship with anxiety
emtrends(m9a, pairwise ~ contingency, var = "ta")


theme_set(theme_sjplot())
plot_model(m9a, type = "pred", terms = c("ta", "contingency"), show.data = TRUE )

data %>%
  group_by(contingency) %>%
  summarise_at(c("m1m2_diff", "m1m3_diff", "m2m3_diff", "MF_diff"), mean, na.rm = TRUE)

```




### 1-state vs n-state

```{r}
data<-read.csv(paste(path_root, "/output/tables_and_csvs/data_across_mods.csv", sep=""))
data["m1m3_diff"] <- data$m1_BIC - data$m3_BIC
c<-cor.test(data$ta, data$m1m3_diff)

df <- data[data$contingency %in% c("90/10"),]
g <- ggplot(data = df, aes(x = m1m3_diff, y = ta, color=(ta) )) +
geom_point( size = 5, alpha = 1, show.legend = FALSE) +
geom_smooth(method='lm', formula= y~x, alpha=0.3, show.legend = FALSE, color="black", fill="pink") +
scale_color_gradient(low="magenta", high="gold1") +
geom_vline(xintercept = 0, linetype = "longdash") +
theme_bw() +
xlim(-70, 140) +
#stat_cor(
#   aes(label = paste(..rr.label.., ..p.label.., sep = "~`,`~")),
#  label.x = 3
#) +  
  
stat_cor(method = "pearson",  alternative = "two.sided",  cor.coef.name = c("r"),  label.sep = ", ",  label.x.npc = "left",  label.y.npc = "top", digits = 3, r.digits = 3, p.digits = 3) + 
raincloud_theme +
  labs(y= "Trait anxiety", x="Relative fit") 
g
#ggsave(paste(figpath, "Figure_models/Figure_correlation_TA_modelfit.pdf", sep=""), width = 5, height = 4, dpi = 120)
```
#### Order check for relative model fit

```{r}
 data<-read.csv(paste(path_root, "output/tables_and_csvs/model_fit_final_full.csv", sep=""))
data<-data[data$study==3,]
data<-assign_var_types(data, c("contingency", "ta", "study", "ids", "order"))  
#m9a <- rlmer(m1m3_diff ~ ta*contingency + (1|ids) , data)
m9a <- lmer(m1m3_diff ~ ta*contingency*order_str + (1|ids) , data)
anova(m9a)

## means of relative fit
g <- ggplot(aes(x=contingency, y=m1m3_diff, fill=interaction(contingency, order_str)), data=data) + 
  #geom_flat_violin(position = position_nudge(x = .2, y = 0), lwd=1.2, alpha = .8, show.legend = FALSE) +
  geom_point(aes(y=m1m3_diff, fill=interaction(contingency*order_str)), position = position_jitter(width = .15), size = 2, alpha = 0.5, show.legend = FALSE) +
  geom_boxplot(width = .2, outlier.shape = NA, lwd=1.2,alpha = 0.7, show.legend = TRUE) +
  
  expand_limits(x = 3) +
  scale_color_manual(values=c("maroon3", "yellow4", "dodgerblue4")) +
  scale_fill_manual(values=rep(c("maroon3", "yellow4", "dodgerblue4"),3), name="") +
  # coord_flip() +
  theme_bw() +
  raincloud_theme +
    labs(y= "relative fit", x="Session") 
  g
pal <- get_colors("ond")
## plot with anxiety 
g <- ggplot(data = data, aes(y = m1m3_diff, x = ta_orig_scale, color=(m1m3_diff) )) +
geom_point( size = 3, alpha = 0.9, show.legend = FALSE) +
geom_smooth(method='lm', formula= y~x, alpha=0.3, show.legend = FALSE, color="black") +
scale_color_gradient(low=pal[1], high=pal[1]) +
theme_bw() +
raincloud_theme +
  stat_cor(method = "pearson",  alternative = "two.sided",  cor.coef.name = c("r"),  label.sep = ", ",  label.x.npc = "left",  label.y.npc = "top", digits = 3, r.digits = 3, p.digits = 3) + 
  labs(y= "Log Steepness", x="Trait anxiety")  + 
  facet_grid(cols=vars(contingency), rows = vars(order_str))
g

```

#### i. bsim_v3_model_switches
```{r}
 data<-read.csv(paste(path_root, "/output/tables_and_csvs/model_switch_data.csv", sep=""))
df<-data[!is.na(data$model_switch_locked),]

pal <- get_colors("ond")

g <- ggplot(data = df, aes(y = model_switch_locked, x = contingency, fill = contingency)) +
geom_flat_violin(position = position_nudge(x = .2, y = 0), alpha = .8, lwd=1.2) +
geom_point(aes(y = model_switch_locked, color=contingency), position = position_jitter(width = .15), size = 1, alpha = 0.5, show.legend = FALSE) +
geom_boxplot(width = .2, outlier.shape = NA, alpha = 0.7, lwd=1.2) +
expand_limits(x = 3) +

scale_color_manual(values = c(pal[17], pal[17], pal[17])) +
scale_fill_manual(values = c(pal[17], pal[17], pal[17])) + 
# coord_flip() +
theme_bw() +
raincloud_theme +
theme(legend.position = "right") + 
labs(y= "Model-estimated switch point", x="Session") +
#  scale_x_discrete(labels=c("hi-prob" = "HC", "low-prob" =  "LC")) + 
guides(fill=guide_legend(nrow=2,byrow=TRUE)) 

g

#### or average switch point per participant/session
df2 = df %>%
  group_by(id, contingency) %>%
  summarise_at("model_switch_locked", mean, na.rm = TRUE)

g <- ggplot(data = df2, aes(y = model_switch_locked, x = contingency, fill = contingency)) +
geom_flat_violin(position = position_nudge(x = .2, y = 0), alpha = .8, lwd=1.2, show.legend = FALSE) +
geom_point(aes(y = model_switch_locked, color=contingency), position = position_jitter(width = .15), size = 2, alpha = 0.5, show.legend = FALSE) +
geom_boxplot(width = .2, outlier.shape = NA, alpha = 0.7, lwd=1.2, show.legend = FALSE) +
expand_limits(x = 3) +
geom_hline(yintercept = 0) +
scale_color_manual(values = c(pal[17], pal[17], pal[17])) +
scale_fill_manual(values = c(pal[17], pal[17], pal[17])) +  
# coord_flip() +
theme_bw() +
raincloud_theme +
theme(legend.position = "right") + 
labs(y= "Model-estimated switch point", x="Session") +
#  scale_x_discrete(labels=c("hi-prob" = "HC", "low-prob" =  "LC")) + 
guides(fill=guide_legend(nrow=2,byrow=TRUE)) 

g
 df2 %>%
  group_by(contingency) %>%
  summarise_at("model_switch_locked", mean, na.rm = TRUE)
 
m <- lmer(data=df, model_switch_locked ~ ta*contingency + (1|id) + (1|study_str))
anova(m)
joint_tests(m, by="contingency")
```

#### ii. model fit * anx correlation: running window

```{r}
#data<-read.csv(paste(path_root, "/output/tables_and_csvs/model_fit_anxiety_running_window_by_half.csv", sep=""))
data <- read.csv(paste(path_root, "/output/tables_and_csvs/model_fit_anxiety_running_window_locked_to_est_reversal.csv", sep=""))
g <- ggplot(data, aes(x=win_start, y=r, color=contingency)) +
  geom_line(size=2) 
#facet_grid(cols=vars(half))   
g

```






### g. BSIM parameters
#### ETA
```{r}
data<-read.csv(paste(path_root, "/output/tables_and_csvs/models_no_states_and_switches_data.csv", sep=""))
#data<-read.csv(paste(path_root, "/output/tables_and_csvs/params_lbeta_v3.csv", sep=""))


vars <- c("contingency", "ta", "study",  "ids")
data <- assign_var_types(data, vars)

df<-data
m11g1<-lmer(eta_reversalbsim ~ contingency + (1|ids) + (1|study_str), df)
m11g2<-lmer(eta_reversalbsim ~ ta*contingency + (1|ids) + (1|study_str), df)
anova(m11g1, m11g2)

anova(m11g2)
summary(m11g2)

df = data %>%
  group_by(ids, ta) %>%
  summarise_at("eta_reversalbsim", mean, na.rm = TRUE)

g <- ggplot(data = df, aes(y = eta_reversalbsim, x = ta )) +
geom_point( size = 3, alpha = 0.5, show.legend = FALSE) +
geom_smooth(method='lm', formula= y~x, alpha=0.3) +
scale_fill_manual(values = c(pal[13], pal[13], pal[13])) +
theme_bw() +
raincloud_theme +
labs(y= "bsim eta", x="trait anxiety") 
g

# marginals and tests without anxiety
em11g2 = emmeans(m11g2, specs = pairwise ~ contingency)
em11g2$emmeans

```
#### Create table of all parameters

```{r}

data<-read.csv(paste(path_root, "/output/tables_and_csvs/models_no_states_and_switches_data.csv", sep=""))
data[,grepl( "lambda" , names( data ) )] = exp(data[,grepl( "lambda" , names( data ) )])
library(qwraps2)
#options(qwraps2_markup = "markdown")
params = list(c("tau_sh", "tau_nosh", "al0", "be0", "lambda"), c("tau_sh", "tau_nosh", "al0", "be0", "lambda", "eta"))
mi <- 1
for (m in c("lbetav5", "bsim")) {
  m1d <- cbind(data[,c("contingency", "ids")], data[,grepl( m , names( data ) )])
  for (c in c("harm", "safe", "reversal") ) {
      tdf <- cbind(m1d[,c("contingency", "ids")], m1d[, grepl( c , names( m1d ) )] %>% rename_with(~str_remove(., paste0("_", c, m) )))
      tdf["cue"] <- c
      if (c=="harm") {df <- tdf} else {df <- rbind(df, tdf)}
  }
  print(df)
  new_summary <-
        qsummary(df[, unlist(params[mi])],
           numeric_summaries = list("Mean (SD)" = "~ qwraps2::mean_sd(%s)")) 
  whole <- summary_table(df, new_summary, by = c("cue", "contingency"))
  
  write.table(whole, file = paste0(path_root, "/output/tables_and_csvs/", m ,".txt"), sep = ",", quote = FALSE, row.names = F)
    write.table(whole, file = paste0("/home/ondrej/OneDrive/zika_state_inference_and_anxiety_paper/data/", m ,".csv"), sep = ",", quote = FALSE, row.names = F)
  mi = mi + 1
}
# 1) save the txt
# 2) upload to onedrive
# 3) open with excel 
# 4) rearrange columns! (they are in the wrong order!)
#m1d <- rbind( m1d[,grepl( "safe" , names( m1d ) )], m1d[,grepl( "harm" , names( m1d ) )], m1d[,grepl( "reversal" , names( m1d ) )] )

```

```{r}

data<-read.csv(paste(path_root, "/output/tables_and_csvs/models_no_states_and_switches_data.csv", sep=""))
library(qwraps2)
library(apaTables)
#options(qwraps2_markup = "markdown")
params = list(c("tau_sh", "tau_nosh", "al0", "be0", "lambda"), c("tau_sh", "tau_nosh", "eta", "al0", "be0"))
mi <- 1
for (m in c("lbetav5")) {
  m1d <- cbind(data[,c("contingency", "ids")], data[,grepl( m , names( data ) )])
  for (c in c("harm", "safe", "reversal") ) {
      tdf <- cbind(m1d[,c("contingency", "ids")], m1d[, grepl( c , names( m1d ) )] %>% rename_with(~str_remove(., paste0("_", c, m) )))
      tdf["cue"] <- c
      if (c=="harm") {df <- tdf} else {df <- rbind(df, tdf)}
  }
  print(df)
  apa.2way.table(iv1 = contingency,iv2 = cue, dv = tau_sh, 
               data = df, 
               filename = paste0(path_root, "/output/tables_and_csvs/testable.doc"), 
               show.marginal.means = FALSE, 
               table.number = 1)
  
  #write.table(whole, file = paste0(path_root, "/output/tables_and_csvs/", m ,".txt"), sep = ",", quote = FALSE, row.names = F)
  mi = mi + 1
}






```

#### nostates

```{r}
data<-read.csv(paste(path_root, "/output/tables_and_csvs/models_no_states_and_switches_data.csv", sep=""))
#data<-read.csv(paste(path_root, "/output/tables_and_csvs/params_lbeta_v3.csv", sep=""))


vars <- c("contingency", "ta", "study",  "ids")
data <- assign_var_types(data, vars)

df<-data
m11g1<-lmer(nostates_bsim ~ contingency + (1|ids) + (1|study_str), df)
m11g2<-lmer(nostates_bsim ~ ta*contingency + (1|ids) + (1|study_str), df)
m11g3<-lmer(nostates_bsim ~ tabin*contingency + (1|ids) + (1|study_str), df)
anova(m11g1, m11g2)

anova(m11g2)
summary(m11g2)

df = data %>%
  group_by(ids, ta) %>%
  summarise_at("nostates_bsim", mean, na.rm = TRUE)

g <- ggplot(data = data, aes(y = nostates_bsim, x = ta )) +
geom_point( size = 3, alpha = 0.5, show.legend = FALSE) +
geom_smooth(method='lm', formula= y~x, alpha=0.3) +
scale_fill_manual(values = c(pal[13], pal[13], pal[13])) +
theme_bw() +
raincloud_theme +
labs(y= "bsim nostates", x="trait anxiety") + 
  facet_grid(cols=vars(contingency)) 
g

# marginals and tests without anxiety
em11g2 = emmeans(m11g2, specs = pairwise ~ contingency)
em11g2$emmeans
joint_tests(m11g2, by=c("contingency"))

data %>%
  group_by(contingency, tabin) %>%
  summarise_at(c("nostates_bsim"), mean, na.rm = TRUE)

data %>%
  group_by(tabin) %>%
  summarise_at(c("nostates_bsim"), mean, na.rm = TRUE)

data %>%
  summarise_at(c("nostates_bsim"), mean, na.rm = TRUE)

ggplot(data) + 
  geom_bar( aes(y = as.numeric(nostates_bsim), x = as.factor(contingency), fill=interaction(contingency, tabin) ), 
           position = "dodge", stat = "summary", fun.y = "mean") + 
  ylim(0,3)
library(gmodels)
CrossTable(data$tabin,data$nostates_bsim, prop.t=TRUE, prop.r=TRUE, prop.c=TRUE)
```
#### noswitches

```{r}
data<-read.csv(paste(path_root, "/output/tables_and_csvs/models_no_states_and_switches_data.csv", sep=""))
#data<-read.csv(paste(path_root, "/output/tables_and_csvs/params_lbeta_v3.csv", sep=""))


vars <- c("contingency", "ta", "study",  "ids")
data <- assign_var_types(data, vars)

df<-data
m11g1<-lmer(noswitches_sub_bsim ~ contingency + (1|ids) + (1|study_str), df)
m11g2<-lmer(noswitches_sub_bsim ~ ta*contingency + (1|ids) + (1|study_str), df)
m11g3<-lmer(noswitches_sub_bsim ~ tabin*contingency + (1|ids) + (1|study_str), df)
anova(m11g1, m11g2, m11g3)

em3 <- emmeans(m11g3, specs = pairwise ~ contingency*tabin)
em3$emmeans
print(df %>%
  group_by(contingency, tabin) %>%
  summarise_at(c("noswitches_sub_bsim"), median, na.rm = TRUE))
print(df %>%
  group_by(contingency, tabin) %>%
  summarise_at(c("noswitches_sub_bsim"), mean, na.rm = TRUE))
print(df %>%
      #  group_by(contingency) %>%
  summarise_at(c("noswitches_sub_bsim"), mean, na.rm = TRUE))


anova(m11g2)
summary(m11g2)

df = data %>%
  group_by(ids, ta) %>%
  summarise_at("noswitches_sub_bsim", mean, na.rm = TRUE)

g <- ggplot(data = data, aes(y = noswitches_sub_bsim, x = ta )) +
geom_point( size = 3, alpha = 0.5, show.legend = FALSE) +
geom_smooth(method='lm', formula= y~x, alpha=0.3, colour=pal[3]) +
scale_fill_manual(values = c(pal[13], pal[13], pal[13])) +
  geom_hline(yintercept=0) +
theme_bw() +
raincloud_theme +
labs(y= "Excessive switches", x="Trait anxiety") + 
  facet_grid(cols=vars(contingency)) 
g

# marginals and tests without anxiety
em11g2 = emmeans(m11g2, specs = pairwise ~ contingency)
em11g2$emmeans
em11g2$contrasts
joint_tests(m11g2, by=c("contingency"))

pal <- get_colors("ond")
g <- ggplot(data = data, aes(y = noswitches_sub_bsim, x = contingency, fill = tabin)) +
geom_flat_violin(position = position_nudge(x = .2, y = 0), alpha = .8,lwd=1.2) +
geom_point(aes(y = noswitches_sub_bsim), position = position_jitter(width = .15), size = 1, alpha = 0.5, show.legend = FALSE) +
geom_boxplot(width = .2, outlier.shape = NA, alpha = 0.7, lwd=1.2, show.legend = FALSE) +
geom_hline(yintercept=c(0), linetype="dashed") +
expand_limits(x = 3) +
scale_color_manual(values = pal[c(11, 12)]) +
scale_fill_manual(values = pal[c(11,12)], name = "Trait anxiety", labels = c("Low", "High")) +
# coord_flip() +

theme_bw() +
raincloud_theme +
theme(strip.text.x = element_text(size = 14,  face = "bold"),
    strip.background = element_rect(color="black", fill="#ebebeb", size=0, linetype="solid")) +
labs(y= "Excessive switches", x="Session") + 
scale_x_discrete(labels=c("acq" = "High", "ext" =  "Low")) 

g




############################################################################################

g <- ggplot(data = data, aes(y = noswitches_sub_bsim, x = contingency, fill=contingency)) +
#geom_flat_violin(position = position_nudge(x = .2, y = 0), alpha = .8,lwd=1.2) +
#geom_point(aes(y = noswitches_sub_bsim), position = position_jitter(width = .15), size = 1, alpha = 0.5, show.legend = FALSE) +
geom_boxplot(width = .2, outlier.shape = NA, alpha = 0.7, lwd=1.2, show.legend = FALSE) +
#  geom_bar() +
geom_hline(yintercept=c(0), linetype="dashed") +
expand_limits(x = 3) +
scale_color_manual(values = pal[c(11, 11,11)]) +
scale_fill_manual(values = pal[c(11,11,11)]) +
# coord_flip() +

theme_bw() +
raincloud_theme +
theme(strip.text.x = element_text(size = 14,  face = "bold"),
    strip.background = element_rect(color="black", fill="#ebebeb", size=0, linetype="solid")) +
labs(y= "Excessive switches", x="Session") + 
scale_x_discrete(labels=c("acq" = "High", "ext" =  "Low")) +
  ylim(-15 ,15)

g

print(data %>%
  group_by(contingency) %>%
  summarise_at(c("noswitches_sub_bsim"), median, na.rm = TRUE))
 # ylim(0,3)
```

#### Syntehtic fit: number of true versus estimatd switches

```{r}

data<-read.csv(paste(path_root, "/output/tables_and_csvs/synthetic_switches.csv", sep=""))
df = data %>%
  group_by(truesw, contingency) %>%
  summarise_at("estsw", median, na.rm = TRUE)

g <- ggplot(data = df, aes(y = estsw, x = truesw )) +
geom_point( size = 3, alpha = 0.5, show.legend = FALSE) +
geom_smooth(method='lm', formula= y~x, alpha=0.3, colour=pal[3]) +
scale_fill_manual(values = c(pal[13], pal[13], pal[13])) +
  geom_hline(yintercept=0) +
theme_bw() +
raincloud_theme +
labs(y= "Estimated_switches", x="true_switches") + 
 # ylim(0,15) + xlim(0,15) +
  facet_grid(cols=vars(contingency)) 
g


```

#### BSIM sh.nosh learning

```{r}

data<-read.csv(paste(path_root, "/output/tables_and_csvs/models_no_states_and_switches_data.csv", sep=""))
#data<-read.csv(paste(path_root, "/output/tables_and_csvs/params_lbeta_v3.csv", sep=""))
vars <- c("contingency", "ta", "study",  "ids")
data <- assign_var_types(data, vars)
df <- data %>% 
     melt(id.vars = c("ids", "ta", "study_str", "contingency"), measure.vars = c("tau_sh_reversalbsim", "tau_nosh_reversalbsim"), value.name = "tau", variable.name = "outcome" )
 df$outcome <- mapvalues(df$outcome,
                             from = c("tau_sh_reversalbsim", "tau_nosh_reversalbsim"),
                             to =c("sh", "nosh"))
 
 m <- lmer(data=df, tau ~ contingency*outcome*ta + (1|ids) + (1|study_str) )
anova(m)
memm <- emmeans(m, specs = pairwise ~ outcome)
memm$emmeans

pal <- get_colors("ond")

g <- ggplot(data = df, aes(y = tau, x = outcome, fill = outcome)) +
geom_flat_violin(position = position_nudge(x = .2, y = 0), alpha = .8, lwd=1.2) +
geom_point(aes(y = tau, color=outcome), position = position_jitter(width = .15), size = 1, alpha = 0.5, show.legend = FALSE) +
geom_boxplot(width = .2, outlier.shape = NA, alpha = 0.7, lwd=1.2, show.legend = FALSE) +
expand_limits(x = 3) +

scale_color_manual(values = pal[c(1,3)]) +
scale_fill_manual(values = pal[c(1,3)], name = "Outcoem") +  
# coord_flip() +
theme_bw() +
raincloud_theme +
theme(legend.position = "right") + 
labs(y= "Mean probability", x="Outcome") +
  scale_x_discrete(labels=c("hi-prob" = "HC", "low-prob" =  "LC")) + 
guides(fill=guide_legend(nrow=2,byrow=TRUE)) 

g

```
#### BSSM in stable cues
```{r}
data<-read.csv(paste(path_root, "/output/tables_and_csvs/models_no_states_and_switches_data.csv", sep=""))
#data<-read.csv(paste(path_root, "/output/tables_and_csvs/params_lbeta_v3.csv", sep=""))
vars <- c("contingency", "ta", "study",  "ids")
data <- assign_var_types(data, vars)
df <- data %>% 
     melt(id.vars = c("ids", "ta", "study_str", "contingency"), measure.vars = c("tau_sh_harmbssm", "tau_nosh_harmbssm", "tau_sh_safebssm", "tau_nosh_safebssm"), value.name = "tau", variable.name = "tempstr" )
 df$outcome <- mapvalues(df$tempstr,
                             from = c("tau_sh_harmbssm", "tau_nosh_harmbssm", "tau_sh_safebssm", "tau_nosh_safebssm"),
                             to =c("sh", "nosh", "sh", "nosh"))
df$cue <- mapvalues(df$tempstr,
                             from = c("tau_sh_harmbssm", "tau_nosh_harmbssm", "tau_sh_safebssm", "tau_nosh_safebssm"),
                             to =c("harm", "harm", "safe", "safe"))
 
 m <- lmer(data=df, tau ~ contingency*outcome*ta*cue + (1|ids) + (1|study_str) )
anova(m)
memm <- emmeans(m, specs = pairwise ~ cue*outcome)
memm$emmeans

pal <- get_colors("ond")

g <- ggplot(data = df, aes(y = tau, x = outcome, fill = interaction(outcome,cue))) +
geom_flat_violin(position = position_nudge(x = .2, y = 0), alpha = .8, lwd=1.2) +
geom_point(aes(y = tau, color=outcome), position = position_jitter(width = .15), size = 1, alpha = 0.5, show.legend = FALSE) +
geom_boxplot(width = .2, outlier.shape = NA, alpha = 0.7, lwd=1.2, show.legend = FALSE) +
expand_limits(x = 3) +

scale_color_manual(values = pal[c(3,1,4,2)]) +
scale_fill_manual(values = pal[c(3,1,4,2)], name = "Outcoem") +  
# coord_flip() +
theme_bw() +
raincloud_theme +
theme(legend.position = "right") + 
labs(y= "Mean probability", x="Outcome") +
  scale_x_discrete(labels=c("hi-prob" = "HC", "low-prob" =  "LC")) + 
guides(fill=guide_legend(nrow=2,byrow=TRUE)) 

g
```

#### Lbeta sh.nosh learning

```{r}

data<-read.csv(paste(path_root, "/output/tables_and_csvs/models_no_states_and_switches_data.csv", sep=""))
#data<-read.csv(paste(path_root, "/output/tables_and_csvs/params_lbeta_v3.csv", sep=""))
vars <- c("contingency", "ta", "study",  "ids")
data <- assign_var_types(data, vars)
df <- data %>% 
     melt(id.vars = c("ids", "ta", "study_str", "contingency"), measure.vars = c("tau_sh_reversallbetav5", "tau_nosh_reversallbetav5"), value.name = "tau", variable.name = "outcome" )
 df$outcome <- mapvalues(df$outcome,
                             from = c("tau_sh_reversalbssm", "tau_nosh_reversalbssm"),
                             to =c("sh", "nosh"))
 
 m <- lmer(data=df, tau ~ contingency*outcome*ta + (1|ids) + (1|study_str) )
anova(m)
memm <- emmeans(m, specs = pairwise ~ outcome)
memm$emmeans

memm <- emmeans(m, specs = pairwise ~ outcome*contingency)
memm$emmeans

g <- ggplot(data = df, aes(y = tau, x = outcome, fill = outcome)) +
geom_flat_violin(position = position_nudge(x = .2, y = 0), alpha = .8, lwd=1.2) +
geom_point(aes(y = tau, color=outcome), position = position_jitter(width = .15), size = 1, alpha = 0.5, show.legend = FALSE) +
geom_boxplot(width = .2, outlier.shape = NA, alpha = 0.7, lwd=1.2, show.legend = FALSE) +
expand_limits(x = 3) +

scale_color_manual(values = pal[c(1,3)]) +
scale_fill_manual(values = pal[c(1,3)], name = "Outcoem") +  
# coord_flip() +
theme_bw() +
raincloud_theme +
theme(legend.position = "right") + 
labs(y= "Mean probability", x="Outcome") +
  scale_x_discrete(labels=c("hi-prob" = "HC", "low-prob" =  "LC")) + 
guides(fill=guide_legend(nrow=2,byrow=TRUE)) 

g

```


## 12. Model-free learning rates (oddball vs learning)
### a. type:contingency - all learning
Meant to assess whether high trait anxious learn from oddball trials or whether they truly infer the structure

```{r}
data<-read.csv(paste(path_root, "/output/tables_and_csvs/oddball_data.csv", sep=""))
data$lrtype = to_factor(data$lrtype)
data$ids = to_factor(data$ids)
data$contingency = to_factor(data$contingency)
data$ta <- demean(data$ta)
df<-data


m12a1<-lmer(mflr_overall ~ contingency*lrtype + (1|ids) + (1|study_str), df)
m12a2<-lmer(mflr_overall ~ ta*contingency*lrtype + (1|ids) + (1|study_str), df)
anova(m12a1, m12a2)

anova(m12a2)

# marginals and tests without anxiety
em12a2 = emmeans(m12a2, specs = pairwise ~ contingency:lrtype)
em12a2$emmeans


joint_tests(m12a2, by = "lrtype")
joint_tests(m12a2, by = "contingency")

em12a1 = emmeans(m12a1, specs = pairwise ~ lrtype)
em12a1$emmeans

# relationship with anxiety
emtrends(m12a2, pairwise ~ contingency:lrtype, var = "ta")

theme_set(theme_sjplot())
plot_model(m12a2, type = "pred", terms = c("ta", "lrtype", "contingency"))

```
### a2. previous + outcome! MAIN MODEL!
```{r}
library(reshape2)
data<-read.csv(paste(path_root, "/output/tables_and_csvs/oddball_data_n5.csv", sep=""))
data$lrtype = to_factor(data$lrtype)
data$ids = to_factor(data$ids)
data$ta <- demean(data$ta)
df2 <- melt(data, measure.vars=c("mflr_sh","mflr_nosh"),
    value.name = "mflr_melted", variable.name="outcome")
df2$outcome = to_factor(df2$outcome)
df2["tabin"]<-dicho(df2$ta)
df2$tabin <- mapvalues(df2$tabin,
                           from = c(0,1),
                           to = c("lowAnx", "hiAnx"))



m12b1<-lmer(mflr_melted ~ contingency*lrtype*outcome + (1|ids) + (1|study_str), df2)
m12b2<-lmer(mflr_melted ~ ta*contingency*lrtype*outcome + (1|ids) + (1|study_str), df2)
#just for tabin visualization 
m12b3<-lmer(mflr_melted ~ tabin*contingency*lrtype*outcome + (1|ids) + (1|study_str), df2)
anova(m12b1, m12b2)

anova(m12b2)

# marginals and tests without anxiety
em12b2 = emmeans(m12b2, specs = pairwise ~ contingency:lrtype:outcome)
em12b2$emmeans

em12b2b = emmeans(m12b2, specs = pairwise ~ contingency:outcome)
em12b2b$emmeans


em12b2b = emmeans(m12b2, specs = pairwise ~ outcome | contingency)
em12b2b$emmeans
em12b2b$contrasts

em12b2b = emmeans(m12b2, specs = pairwise ~ contingency | outcome)
em12b2b$emmeans
em12b2b$contrasts

em12b2c = emmeans(m12b2, specs = pairwise ~ outcome)
em12b2c$emmeans

em12b2c = emmeans(m12b2, specs = pairwise ~ lrtype)
em12b2c$emmeans

joint_tests(m12b2, by = c("contingency", "lrtype"))
joint_tests(m12b2, by = "lrtype")
joint_tests(m12b2, by = "contingency")


# relationship with anxiety
emtrends(m12b2, pairwise ~ lrtype, var = "ta")

theme_set(theme_sjplot())
plot_model(m12b2, type = "pred", terms = c("outcome"))
plot_model(m12b3, type = "pred", terms = c("tabin", "lrtype"))
plot_model(m12b3, type = "pred", terms = c("outcome", "lrtype", "tabin"))


```

### a3. only after 10 trials of new block - anxiety and best fitting model
```{r}
library(reshape2)
data<-read.csv(paste(path_root, "/output/tables_and_csvs/oddball_data_n5.csv", sep=""))
data$lrtype = to_factor(data$lrtype)
data$ids = to_factor(data$ids)
data$ta <- demean(data$ta)
df2 <- melt(data, measure.vars=c("mflr_sh","mflr_nosh"),
    value.name = "mflr_melted", variable.name="outcome")
df2$outcome = to_factor(df2$outcome)
df2["tabin"]<-dicho(df2$ta)
df2$tabin <- mapvalues(df2$tabin,
                           from = c(0,1),
                           to = c("lowAnx", "hiAnx"))


fitd<-read.csv(paste(path_root, "output/tables_and_csvs/model_fit_final_full.csv", sep=""))
#fitd<-fitd[fitd$contingency %in% "90/10",]
fitd<-assign_var_types(fitd, c("contingency", "ta", "study", "ids"))  
fitd["best_model"] <- apply(fitd[,c("m1_BIC", "m3_BIC")], 1, which.min)
fitd$best_model <- mapvalues(fitd$best_model,
                            from = c(1,2),
                            to =c("1-state", "n-state"))
fitd <- fitd[,c("specID", "best_model", "m1m3_diff")]
df2 <-merge(df2, fitd, by="specID")


df3 = df2 %>%
  group_by(ids,study_str,best_model,contingency) %>%
  summarise_at("mflr_melted", mean, na.rm = TRUE)

m12b1<-lmer(mflr_melted ~ contingency*lrtype*outcome + (1|ids) + (1|study_str), df2)
m12b2<-lmer(mflr_melted ~ ta*contingency*lrtype*outcome + (1|ids)+ (1|study_str), df2)
#just for tabin visualization 
m12b3<-lmer(mflr_melted ~ tabin*contingency*lrtype*outcome + (1|ids)+ (1|study_str), df2)
m12b4<-lmer(mflr_melted ~ best_model*contingency + (1|ids)+ (1|study_str), df3)
m12b5<-lmer(mflr_melted ~ ta*best_model*contingency*lrtype*outcome + (1|ids)+ (1|study_str), df2)

m12b6 <-lmer(mflr_melted ~ ta*m1m3_diff*contingency*lrtype + (1|ids)+ (1|study_str), df2)


#anova(m12b2)
anova(m12b4)
em12b4 = emmeans(m12b4, specs = pairwise ~ best_model)
em12b4$emmeans
joint_tests(m12b4, by = "contingency")

#anova(m12b5)

# marginals and tests without anxiety
em12b2 = emmeans(m12b2, specs = pairwise ~ lrtype:outcome)
em12b2$emmeans

em12b2b = emmeans(m12b2, specs = pairwise ~ outcome)
em12b2b$emmeans

joint_tests(m12b2, by = "lrtype")


# relationship with anxiety
emtrends(m12b2, pairwise ~ lrtype, var = "ta")

theme_set(theme_sjplot())
plot_model(m12b3, type = "pred", terms = c("tabin", "lrtype"))
plot_model(m12b5, type = "pred", terms = c("best_model", "lrtype"))


# by mest model
plot_model(m12b4, type = "pred", terms = c("best_model"))


```
###  differnece between meaningful and oddballs across all three sessions
```{r}
library(reshape2)
data<-read.csv(paste(path_root, "/output/tables_and_csvs/oddball_data_n5.csv", sep=""))
#data<-data[data$contingency %in% "90/10",]
data$mflr_overall <- (data$mflr_overall) 
data$lrtype = to_factor(data$lrtype)
data$ids = to_factor(data$ids)
data$ta <- demean(data$ta)
data["tabin"]<-dicho(data$ta)
data$tabin <- mapvalues(data$tabin,
                           from = c(0,1),
                           to = c("lowAnx", "hiAnx"))

odd<-data[data$lrtype %in% "odd",]
common<-data[data$lrtype %in% "common",]
data <- merge(odd, common, by="specID", all.x = TRUE)
data$mflr_diff <- data$mflr_overall.y - data$mflr_overall.x
data$mflr_diff[is.na(data$mflr_diff) | is.infinite(data$mflr_diff)] <- median(data$mflr_diff[!is.infinite(data$mflr_diff)], na.rm = TRUE)
data <- data[, -grep(".y", colnames(data))]
colnames(data)<-gsub(".x","",colnames(data))
data <- data %>%
  group_by(ids) %>%
  summarise_at(c("mflr_diff"), mean, na.rm = TRUE)


fitd<-read.csv(paste(path_root, "output/tables_and_csvs/model_fit_final_full.csv", sep=""))
fitd<-assign_var_types(fitd, c("contingency", "ta", "study", "ids"))   
fitd <- fitd %>%
  group_by(ids, ta, study_str) %>%
  summarise_at(c("m1_BIC", "m3_BIC", "m1m3_diff"), mean, na.rm = TRUE)

fitd["best_model"] <- apply(fitd[,c("m1_BIC", "m3_BIC")], 1, which.min)
fitd$best_model <- mapvalues(fitd$best_model,
                            from = c(1,2),
                            to =c("1-state", "n-state"))
fitd <- fitd[,c("ids", "best_model", "study_str", "m1m3_diff")]
data <-merge(data, fitd, by="ids")

data$best_model <- as.factor(data$best_model)
wilcox.test(mflr_diff~best_model, data=data)
t.test(mflr_diff~best_model, alternative = "two.sided", var.equal = FALSE, data=data)

data %>%
  group_by(best_model) %>%
  summarise_at(c("mflr_diff"), mean, na.rm = TRUE)

g <- ggplot(data = data, aes(y = mflr_diff, x = best_model, fill =  best_model)) +
geom_flat_violin(position = position_nudge(x = .2, y = 0), alpha = .8, lwd=1.2) +
geom_point(aes(color= best_model), position =   position_jitterdodge(  jitter.width = .45,  dodge.width = 1), size = 2, alpha = 0.5, show.legend=FALSE) +  
geom_boxplot(inherit.aes = TRUE, width = 0.25, lwd=1.2, outlier.shape = NA, alpha = 0.7, show.legend = FALSE) + 

expand_limits(x = 3) +
scale_color_manual(values = c(pal[1], pal[3], pal[4], pal[3])) +
scale_fill_manual(values = c(pal[1], pal[3], pal[4], pal[3]), name = "", labels = c("1-state", "n-state")) +
theme_bw() +
raincloud_theme +
theme(strip.text.x = element_text(size = 14,  face = "bold"),
      strip.background = element_rect(color="black", fill="#ebebeb", size=0, linetype="solid")) +
theme(legend.position = "top") +  #c(0.8, 0.2)

labs(y= "meaningful-oddball", x="model")  +

  guides(fill=guide_legend(nrow=1,byrow=TRUE)) 
g

```


### a4 differnece between meaningful and oddballs
```{r}
library(reshape2)
data<-read.csv(paste(path_root, "/output/tables_and_csvs/oddball_data.csv", sep=""))
#data$mflr_overall <- log(data$mflr_overall) 
data$lrtype = to_factor(data$lrtype)
data$ids = to_factor(data$ids)
data$ta <- demean(data$ta)
data["tabin"]<-dicho(data$ta)
data$tabin <- mapvalues(data$tabin,
                           from = c(0,1),
                           to = c("lowAnx", "hiAnx"))
#data = data %>%
#        group_by(lrtype) %>%
#        mutate(mflr_overall = scale(mflr_overall))
odd<-data[data$lrtype %in% "odd",]
common<-data[data$lrtype %in% "common",]
data <- merge(odd, common, by="specID", all.x = TRUE)
data$mflr_diff <- data$mflr_overall.y - data$mflr_overall.x

#data$mflr_diff[is.na(data$mflr_diff) | is.infinite(data$mflr_diff)] <- mean(data$mflr_diff[!is.infinite(data$mflr_diff)], na.rm = TRUE)
data <- data[, -grep(".y", colnames(data))]
colnames(data)<-gsub(".x","",colnames(data))

fitd<-read.csv(paste(path_root, "output/tables_and_csvs/model_fit_final_full.csv", sep=""))
fitd<-assign_var_types(fitd, c("contingency", "ta", "study", "ids"))   
fitd["best_model"] <- apply(fitd[,c("m1_BIC", "m3_BIC")], 1, which.min)
fitd$best_model <- mapvalues(fitd$best_model,
                            from = c(1,2),
                            to =c("1-state", "n-state"))
fitd <- fitd[,c("specID", "best_model", "contingency", "study_str", "m1m3_diff")]
data <-merge(data, fitd, by="specID")

#df<- data[data$contingency %in% "90/10",]
#res <- t.test(mflr_diff ~ best_model, data = df, var.equal = TRUE)
#res

m12b4<-lmer(mflr_diff ~ best_model*contingency + (1|ids) , data)
anova(m12b4)
em12b4 = emmeans(m12b4, specs = pairwise ~ best_model)
em12b4$emmeans

em12b4b = emmeans(m12b4, specs = pairwise ~ contingency*best_model)
em12b4b$emmeans
joint_tests(m12b4, by = "contingency")


### continuous model fit 
#df<- data[data$contingency %in% "90/10",]
df<-data
m12b4<-lmer(mflr_diff ~ m1m3_diff*contingency + (1|ids) , df)
anova(m12b4)
em12b4 = emmeans(m12b4, specs = pairwise ~ m1m3_diff)
em12b4$emmeans

em12b4b = emmeans(m12b4, specs = pairwise ~ contingency*m1m3_diff)
em12b4b$emmeans
joint_tests(m12b4, by = "contingency")

library(tidyr)

m13c<-lmer(mflr_diff ~ m1m3_diff*contingency + (1|ids)+ (1|study_str), data = df)

anova(m13c)

joint_tests(m13c, by = c( "contingency"))

g <- ggplot(data = df, aes(x = mflr_diff, y = m1m3_diff, color=(m1m3_diff) ), palette="Greens") +
geom_point( size = 5, alpha = 0.9, show.legend = FALSE) +
geom_smooth(method='lm', formula= y~x, alpha=0.3, show.legend = FALSE, color="black", fill="lightgray") +
scale_color_gradient(low="dodgerblue1", high="dodgerblue1") +
theme_bw() +
  stat_cor(method = "pearson",  alternative = "two.sided",  cor.coef.name = c("r"),  label.sep = ", ",  label.x.npc = "left",   digits = 3, r.digits = 3, p.digits = 3, show.legend = FALSE) + 

raincloud_theme +
  labs(y= "Relative fit", x="Learning rate\n(meaningful-oddball)") +
    facet_grid(cols=vars(contingency))
g




```


### b. meaningful - oddball and anxiety

```{r}
library(reshape2)
data<-read.csv(paste(path_root, "/output/tables_and_csvs/oddball_data_n5.csv", sep=""))
#data$mflr_overall <- log(data$mflr_overall) 
data$lrtype = to_factor(data$lrtype)
data$ids = to_factor(data$ids)
data$ta <- demean(data$ta)
data["tabin"]<-dicho(data$ta)
data$tabin <- mapvalues(data$tabin,
                           from = c(0,1),
                           to = c("lowAnx", "hiAnx"))
#data = data %>%
#        group_by(lrtype) %>%
#        mutate(mflr_overall = scale(mflr_overall))
odd<-data[data$lrtype %in% "odd",]
common<-data[data$lrtype %in% "common",]
data <- merge(odd, common, by="specID", all.x = TRUE)
data$mflr_diff <- data$mflr_overall.y - data$mflr_overall.x

#data$mflr_diff[is.na(data$mflr_diff) | is.infinite(data$mflr_diff)] <- mean(data$mflr_diff[!is.infinite(data$mflr_diff)], na.rm = TRUE)
data <- data[, -grep(".y", colnames(data))]
colnames(data)<-gsub(".x","",colnames(data))

fitd<-read.csv(paste(path_root, "output/tables_and_csvs/model_fit_final_full.csv", sep=""))
fitd<-assign_var_types(fitd, c("contingency", "ta", "study", "ids"))   
fitd["best_model"] <- apply(fitd[,c("m1_BIC", "m3_BIC")], 1, which.min)
fitd$best_model <- mapvalues(fitd$best_model,
                            from = c(1,2),
                            to =c("1-state", "n-state"))
fitd <- fitd[,c("specID", "best_model", "contingency", "study_str", "m1m3_diff")]
data <-merge(data, fitd, by="specID")

#df<- data[data$contingency %in% "90/10",]
#res <- t.test(mflr_diff ~ best_model, data = df, var.equal = TRUE)
#res

m12b4<-lmer(mflr_diff ~ ta*contingency + (1|ids) , data)
anova(m12b4)



em12b4b = emmeans(m12b4, specs = pairwise ~ contingency)
em12b4b$emmeans
joint_tests(m12b4, by = "contingency")
emtrends(m12b4, pairwise ~ contingency,  var = "ta")




```

### c. contingency - only meaningful learning (after reversal)

```{r}
data<-read.csv(paste(path_root, "/output/tables_and_csvs/oddball_data_n5.csv", sep=""))
data$lrtype = to_factor(data$lrtype)
data$ids = to_factor(data$ids)
data$ta <- demean(data$ta)
df<-data[which(data$lrtype %in% c("common")),]


m12c1<-lmer(mflr_overall ~ contingency + (1|ids) + (1|study_str), df)
m12c2<-lmer(mflr_overall ~ ta*contingency + (1|ids) + (1|study_str), df)
anova(m12c1, m12c2)

anova(m12c2)

# marginals and tests without anxiety
em12c2 = emmeans(m12c2, specs = pairwise ~ contingency)
em12c2$emmeans
em12c2$contrasts
joint_tests(m12c2, by = "contingency")


# relationship with anxiety
emtrends(m12c2, pairwise ~ contingency, var = "ta")

theme_set(theme_sjplot())
plot_model(m12c2, type = "pred", terms = c("ta",  "contingency"))

```

## 13. Oddball vs meaningful: volatility-based methods
```{r}
data<-read.csv(paste(path_root, "/output/full_behavioural_dataset_study_pX_real_data.csv", sep=""))
data<-data[data$Trial_Type==3,]
data<- data[data$oddball_str %in% c("oddball", "meaningful"),]
data$mflr <- log(data$mflr)
data$mflr[is.na(data$mflr) | is.infinite(data$mflr)] <- mean(data$mflr[!is.infinite(data$mflr)], na.rm = TRUE)
#data = data %>%
#        group_by(oddball_str) %>%
#        mutate(mflr = scale(mflr))

fitd<-read.csv(paste(path_root, "output/tables_and_csvs/model_fit_final_full.csv", sep=""))
fitd<-assign_var_types(fitd, c("contingency", "ta", "study", "ids"))  
fitd["best_model"] <- apply(fitd[,c("m1_BIC", "m3_BIC")], 1, which.min)
fitd$best_model <- mapvalues(fitd$best_model,
                            from = c(1,2),
                            to =c("1-state", "n-state"))
fitd <- fitd[,c("specID", "best_model", "contingency", "study_str", "m1m3_diff")]
data <-merge(data, fitd, by="specID")
#data <- data[, -grep(".y", colnames(data))]
colnames(data)<-gsub(".x","",colnames(data))

df <- data %>%
  group_by(id,best_model,oddball_str,contingency, study_str, ta) %>%
  summarise_at(c("mflr"), mean, na.rm = TRUE)

m13a<-lmer(mflr ~ best_model*contingency*oddball_str + (1|id)+ (1|study_str), data = data)
m13b<-lmer(mflr ~ ta*contingency*oddball_str + (1|id)+ (1|study_str), data)
anova(m13a)
em13a = emmeans(m13a, specs = pairwise ~ oddball_str*best_model)
em13a$emmeans
em13a$contrasts
joint_tests(m13a, by = c("best_model"))

em13a = emmeans(m13a, specs = pairwise ~ contingency*oddball_str*best_model)
em13a$emmeans
em13a$contrasts

anova(m13b)

### continuous model fit 
df2 <- data %>%
  group_by(id,m1m3_diff,oddball_str,contingency, study_str, ta) %>%
  summarise_at(c("mflr"), mean, na.rm = TRUE)

m13c<-lmer(mflr ~ m1m3_diff*contingency*oddball_str + (1|id)+ (1|study_str), data = df2)
anova(m13c)
joint_tests(m13c, by = c("oddball_str", "contingency"))

g <- ggplot(data = df2, aes(x = mflr, y = m1m3_diff, color=(m1m3_diff) ), palette="Greens") +
geom_point( size = 5, alpha = 0.9, show.legend = FALSE) +
geom_smooth(method='lm', formula= y~x, alpha=0.3, show.legend = FALSE, color="black", fill="lightgray") +
scale_color_gradient(low="dodgerblue1", high="dodgerblue1") +
theme_bw() +
  stat_cor(method = "kendall",  alternative = "two.sided",  cor.coef.name = c("r"),  label.sep = ", ",  label.x.npc = "left",   digits = 3, r.digits = 3, p.digits = 3, show.legend = FALSE) + 

raincloud_theme +
  labs(y= "Relative fit", x="Learning rate") +
    facet_grid(cols=vars(oddball_str))
g

############### calcualte the difference 
library(tidyr)
df2<-df2 %>%
  pivot_wider(names_from = "oddball_str", values_from = "mflr")
df2$mflr_diff <- df2$meaningful - df2$oddball
m13c<-lmer(mflr_diff ~ m1m3_diff*contingency + (1|id)+ (1|study_str), data = df2)
anova(m13c)
joint_tests(m13c, by = c( "contingency"))

g <- ggplot(data = df2, aes(x = mflr_diff, y = m1m3_diff, color=(m1m3_diff) ), palette="Greens") +
geom_point( size = 5, alpha = 0.9, show.legend = FALSE) +
geom_smooth(method='lm', formula= y~x, alpha=0.3, show.legend = FALSE, color="black", fill="lightgray") +
scale_color_gradient(low="dodgerblue1", high="dodgerblue1") +
theme_bw() +
  stat_cor(method = "pearson",  alternative = "two.sided",  cor.coef.name = c("r"),  label.sep = ", ",  label.x.npc = "left",   digits = 3, r.digits = 3, p.digits = 3, show.legend = FALSE) + 
facet_grid(cols=vars(contingency)) +
raincloud_theme +
  labs(y= "Relative fit", x="Learning rate\n(meaningful-oddball)") 
g
```
## 13b. Oddball vs meaningful: volatility-based methods and anxiety
```{r}

data<-read.csv(paste(path_root, "/output/full_behavioural_dataset_study_pX_real_data.csv", sep=""))
data<-data[data$Trial_Type==3,]
data<- data[data$oddball_str %in% c("oddball", "meaningful"),]
data$mflr <- log(data$mflr)
data$mflr[is.na(data$mflr) | is.infinite(data$mflr)] <- mean(data$mflr[!is.infinite(data$mflr)], na.rm = TRUE)
fitd<-read.csv(paste(path_root, "output/tables_and_csvs/model_fit_final_full.csv", sep=""))
fitd<-assign_var_types(fitd, c("contingency", "ta", "study", "ids"))  
fitd["best_model"] <- apply(fitd[,c("m1_BIC", "m3_BIC")], 1, which.min)
fitd$best_model <- mapvalues(fitd$best_model,
                            from = c(1,2),
                            to =c("1-state", "n-state"))
fitd <- fitd[,c("specID", "best_model", "contingency", "study_str", "m1m3_diff")]
data <-merge(data, fitd, by="specID")
#data <- data[, -grep(".y", colnames(data))]
colnames(data)<-gsub(".x","",colnames(data))

### continuous model fit 
df2 <- data %>%
  group_by(id,oddball_str,contingency,best_model, study_str, ta) %>%
  summarise_at(c("mflr", "m1m3_diff"), mean, na.rm = TRUE)

m13c<-lmer(mflr ~ ta*m1m3_diff*contingency*oddball_str + (1|id)+ (1|study_str), data = df2)
anova(m13c)
joint_tests(m13c, by = c("oddball_str", "contingency"))

g <- ggplot(data = df2, aes(x = mflr, y = ta, color=(ta) ), palette="Greens") +
geom_point( size = 5, alpha = 0.9, show.legend = FALSE) +
geom_smooth(method='lm', formula= y~x, alpha=0.3, show.legend = FALSE, color="black", fill="lightgray") +
scale_color_gradient(low="dodgerblue1", high="dodgerblue1") +
theme_bw() +
  stat_cor(method = "kendall",  alternative = "two.sided",  cor.coef.name = c("r"),  label.sep = ", ",  label.x.npc = "left",   digits = 3, r.digits = 3, p.digits = 3, show.legend = FALSE) + 

raincloud_theme +
  labs(y= "Trait anxiety", x="Learning rate") +
    facet_grid(rows=vars(oddball_str), cols=vars(contingency))
g

g <- ggplot(data = df2, aes(x = mflr, y = m1m3_diff, color=(m1m3_diff) ), palette="Greens") +
geom_point( size = 5, alpha = 0.9, show.legend = FALSE) +
geom_smooth(method='lm', formula= y~x, alpha=0.3, show.legend = FALSE, color="black", fill="lightgray") +
scale_color_gradient(low="dodgerblue1", high="dodgerblue1") +
theme_bw() +
  stat_cor(method = "kendall",  alternative = "two.sided",  cor.coef.name = c("r"),  label.sep = ", ",  label.x.npc = "left",   digits = 3, r.digits = 3, p.digits = 3, show.legend = FALSE) + 

raincloud_theme +
  labs(y= "Relative fit", x="Learning rate") +
    facet_grid(rows=vars(oddball_str), cols=vars(contingency))
g

############### calcualte the difference 
library(tidyr)
df2<-df2 %>%
  pivot_wider(names_from = "oddball_str", values_from = "mflr")
df2$mflr_diff <- df2$meaningful - df2$oddball
m13c<-lmer(mflr_diff ~ ta*m1m3_diff*contingency + (1|id)+ (1|study_str), data = df2)
anova(m13c)
joint_tests(m13c, by = c( "contingency"))

m13d<-lmer(mflr_diff ~ ta*best_model*contingency + (1|id)+ (1|study_str), data = df2)
anova(m13d)
joint_tests(m13d, by = c( "contingency", "best_model"))

g <- ggplot(data = df2, aes(x = mflr_diff, y = ta, color=(ta) ), palette="Greens") +
geom_point( size = 5, alpha = 0.9, show.legend = FALSE) +
geom_smooth(method='lm', formula= y~x, alpha=0.3, show.legend = FALSE, color="black", fill="lightgray") +
scale_color_gradient(low="dodgerblue1", high="dodgerblue1") +
theme_bw() +
  stat_cor(method = "pearson",  alternative = "two.sided",  cor.coef.name = c("r"),  label.sep = ", ",  label.x.npc = "left",   digits = 3, r.digits = 3, p.digits = 3, show.legend = FALSE) +
raincloud_theme +
  labs(y= "Trait anxiety", x="Learning rate\n(meaningful-oddball)") 
g

g <- ggplot(data = df2, aes(x = mflr_diff, y = m1m3_diff, color=(m1m3_diff) ), palette="Greens") +
geom_point( size = 5, alpha = 0.9, show.legend = FALSE) +
geom_smooth(method='lm', formula= y~x, alpha=0.3, show.legend = FALSE, color="black", fill="lightgray") +
scale_color_gradient(low="gray17", high="gray17") +
theme_bw() +
  stat_cor(method = "pearson",  alternative = "two.sided",  cor.coef.name = c("r"),  label.sep = ", ",  label.x.npc = "left",   digits = 3, r.digits = 3, p.digits = 3, show.legend = FALSE) +
raincloud_theme +
  labs(y= "Trait anxiety", x="Learning rate\n(meaningful-oddball)") 
g

```
## 13b. Oddball vs meaningful: z-scored per cat
```{r}


data<-read.csv(paste(path_root, "/output/full_behavioural_dataset_study_pX_real_data.csv", sep=""))
data<-data[data$Trial_Type==3,]
data<- data[data$oddball_str %in% c("oddball", "meaningful"),]
#data$mflr <- log(data$mflr)
#data$mflr[is.na(data$mflr) | is.infinite(data$mflr)] <- mean(data$mflr[!is.infinite(data$mflr)], na.rm = TRUE)

fitd<-read.csv(paste(path_root, "output/tables_and_csvs/model_fit_final_full.csv", sep=""))
fitd<-assign_var_types(fitd, c("contingency", "ta", "study", "ids"))  
fitd["best_model"] <- apply(fitd[,c("m1_BIC", "m3_BIC")], 1, which.min)
fitd$best_model <- mapvalues(fitd$best_model,
                            from = c(1,2),
                            to =c("1-state", "n-state"))
fitd <- fitd[,c("specID", "best_model", "contingency", "study_str", "m1m3_diff")]
data <-merge(data, fitd, by="specID")
colnames(data)<-gsub(".x","",colnames(data))

### continuous model fit 
df2 <- data %>%
  group_by(id,oddball_str,contingency, best_model, study_str, ta) %>%
  summarise_at(c("mflr", "m1m3_diff"), mean, na.rm = TRUE)

#df2 = df2 %>%
#        group_by(oddball_str) %>%
#        mutate(mflr = scale(mflr))


m13c<-lmer(mflr ~ ta*contingency*oddball_str + (1|id)+ (1|study_str), data = df2)
#m13c<-lmer(mflr ~ ta*contingency*oddball_str + (1|id)+ (1|study_str), data = df2)
anova(m13c)
joint_tests(m13c, by = c("contingency"))
em13c <- emmeans(m13c, specs = pairwise ~ oddball_str | contingency )

em13c$emmeans
em13c$contrasts

em13c <- emmeans(m13c, specs = pairwise ~ oddball_str)

em13c$emmeans
em13c$contrasts

emtrends(m13c, pairwise ~ oddball_str | contingency, var = "ta")
emtrends(m13c, pairwise ~ oddball_str , var = "ta")


m13c<-lmer(mflr ~ m1m3_diff*contingency*oddball_str + (1|id)+ (1|study_str), data = df2)
anova(m13c)
joint_tests(m13c, by = c("oddball_str", "contingency"))
em13c <- emmeans(m13c, specs = pairwise ~ oddball_str | contingency, adjust="fdr" )
em13c$emmeans
em13c$contrasts
emtrends(m13c, pairwise ~ oddball_str , var = "m1m3_diff")

g <- ggplot(data = df2, aes(x = mflr, y = ta, color=(ta) ), palette="Greens") +
geom_point( size = 5, alpha = 0.9, show.legend = FALSE) +
geom_smooth(method='lm', formula= y~x, alpha=0.3, show.legend = FALSE, color="black", fill="lightgray") +
scale_color_gradient(low="dodgerblue1", high="dodgerblue1") +
theme_bw() +
  stat_cor(method = "kendall",  alternative = "two.sided",  cor.coef.name = c("r"),  label.sep = ", ",  label.x.npc = "left",   digits = 3, r.digits = 3, p.digits = 3, show.legend = FALSE) + 

raincloud_theme +
  labs(y= "Trait anxiety", x="Learning rate") +
    facet_grid(rows=vars(oddball_str), cols=vars(contingency))
g

g <- ggplot(data = df2, aes(x = mflr, y = m1m3_diff, color=(m1m3_diff) ), palette="Greens") +
geom_point( size = 5, alpha = 0.9, show.legend = FALSE) +
geom_smooth(method='lm', formula= y~x, alpha=0.3, show.legend = FALSE, color="black", fill="lightgray") +
scale_color_gradient(low="dodgerblue1", high="dodgerblue1") +
theme_bw() +
  stat_cor(method = "kendall",  alternative = "two.sided",  cor.coef.name = c("r"),  label.sep = ", ",  label.x.npc = "left",   digits = 3, r.digits = 3, p.digits = 3, show.legend = FALSE) + 

raincloud_theme +
  labs(y= "Relative fit", x="Learning rate") +
    facet_grid(rows=vars(oddball_str), cols=vars(contingency))
g

############### calcualte the difference 
library(tidyr)
df2<-df2 %>%
  pivot_wider(names_from = "oddball_str", values_from = "mflr")
df2$mflr_diff <- df2$meaningful - df2$oddball
m13c<-lmer(mflr_diff ~ ta*m1m3_diff*contingency + (1|id)+ (1|study_str), data = df2)
m13c2<-lmer(mflr_diff ~ best_model*contingency + (1|id)+ (1|study_str), data = df2)
anova(m13c)
joint_tests(m13c, by = c( "contingency"))
em13c <- emmeans(m13c2, specs = pairwise ~ best_model | contingency )
em13c$emmeans
em13c <- emmeans(m13c2, specs = pairwise ~ best_model  )
em13c$emmeans


g <- ggplot(data = df2, aes(x = mflr_diff, y = ta, color=(ta) ), palette="Greens") +
geom_point( size = 5, alpha = 0.9, show.legend = FALSE) +
geom_smooth(method='lm', formula= y~x, alpha=0.3, show.legend = FALSE, color="black", fill="lightgray") +
scale_color_gradient(low="dodgerblue1", high="dodgerblue1") +
theme_bw() +
  stat_cor(method = "pearson",  alternative = "two.sided",  cor.coef.name = c("r"),  label.sep = ", ",  label.x.npc = "left",   digits = 3, r.digits = 3, p.digits = 3, show.legend = FALSE) +
raincloud_theme +
  labs(y= "Trait anxiety", x="Learning rate\n(meaningful-oddball)") 
g

g <- ggplot(data = df2, aes(x = mflr_diff, y = m1m3_diff, color=(m1m3_diff) ), palette="Greens") +
geom_point( size = 5, alpha = 0.9, show.legend = FALSE) +
geom_smooth(method='lm', formula= y~x, alpha=0.3, show.legend = FALSE, color="black", fill="lightgray") +
scale_color_gradient(low="gray17", high="gray17") +
theme_bw() +
  stat_cor(method = "spearman",  alternative = "two.sided",  cor.coef.name = c("r"),  label.sep = ", ",  label.x.npc = "left",   digits = 3, r.digits = 3, p.digits = 3, show.legend = FALSE) +
raincloud_theme +
  labs(y= "relative model fit", x="Learning rate\n(meaningful-oddball)") +
    facet_grid( cols=vars(contingency))
g


```

```{r}
data<-read.csv(paste(path_root, "/output/full_behavioural_dataset_study_pX_real_data.csv", sep=""))
data<-data[data$Trial_Type==3,]
data<- data[data$oddball_str %in% c("oddball", "meaningful"),]
data$mflr <- log(data$mflr)
data$mflr[is.na(data$mflr) | is.infinite(data$mflr)] <- mean(data$mflr[!is.infinite(data$mflr)], na.rm = TRUE)

fitd<-read.csv(paste(path_root, "output/tables_and_csvs/model_fit_final_full.csv", sep=""))
fitd<-assign_var_types(fitd, c("contingency", "ta", "study", "ids"))  
fitd["best_model"] <- apply(fitd[,c("m1_BIC", "m3_BIC")], 1, which.min)
fitd$best_model <- mapvalues(fitd$best_model,
                            from = c(1,2),
                            to =c("1-state", "n-state"))
fitd <- fitd[,c("specID", "best_model", "contingency", "study_str", "m1m3_diff")]
data <-merge(data, fitd, by="specID")
colnames(data)<-gsub(".x","",colnames(data))

#df2 = df2 %>%
#        group_by(oddball_str) %>%
#        mutate(mflr = scale(mflr))


m13c<-lmer(mflr ~ ta*contingency*oddball_str + (1|id)+ (1|study_str), data = data)
anova(m13c)
joint_tests(m13c, by = c("oddball_str", "contingency"))
em13c <- emmeans(m13c, specs = pairwise ~ oddball_str | contingency, adjust="fdr" )
em13c$emmeans
em13c$contrasts
emtrends(m13c, pairwise ~ oddball_str | contingency, var = "ta")

m13d<-lmer(mflr ~ m1m3_diff*contingency*oddball_str + (1|id)+ (1|study_str), data = data)
anova(m13d)
joint_tests(m13d, by = c("contingency"))
emtrends(m13d, pairwise ~ oddball_str | contingency, var = "m1m3_diff",  adjust="fdr")
emtrends(m13d, pairwise ~ oddball_str , var = "m1m3_diff",  adjust="fdr")


df <- data %>%
  group_by(id,oddball_str) %>%
  summarise_at(c("mflr"), mean, na.rm = TRUE)
df<-df %>%
  pivot_wider(names_from = "oddball_str", values_from = "mflr")
df$mflr_diff <- df$meaningful - df$oddball

fitd<-read.csv(paste(path_root, "output/tables_and_csvs/model_fit_final_full.csv", sep=""))
fitd<-assign_var_types(fitd, c("contingency", "ta", "study", "ids"))  
fitd["best_model"] <- apply(fitd[,c("m1_BIC", "m3_BIC")], 1, which.min)
fitd$best_model <- mapvalues(fitd$best_model,
                            from = c(1,2),
                            to =c("1-state", "n-state"))
df2 <- fitd %>%
  group_by(ids) %>%
  summarise_at(c("m1m3_diff"), mean, na.rm = TRUE)
df2$id <- df2$ids
df2 <- df2[,c("m1m3_diff", "id")]
data <-merge(df, df2, by="id")
m<-lm(mflr_diff ~ m1m3_diff, data = data)
anova(m)


```

### only 90/10 condition 

```{r}


data<-read.csv(paste(path_root, "/output/full_behavioural_dataset_study_pX_real_data.csv", sep=""))
data<-data[data$Trial_Type==3,]
data<- data[data$oddball_str %in% c("oddball", "meaningful"),]
data$mflr <- log(data$mflr)
data$mflr[is.na(data$mflr) | is.infinite(data$mflr)] <- mean(data$mflr[!is.infinite(data$mflr)], na.rm = TRUE)

fitd<-read.csv(paste(path_root, "output/tables_and_csvs/model_fit_final_full.csv", sep=""))
fitd<-assign_var_types(fitd, c("contingency", "ta", "study", "ids"))  
fitd["best_model"] <- apply(fitd[,c("m1_BIC", "m3_BIC")], 1, which.min)
fitd$best_model <- mapvalues(fitd$best_model,
                            from = c(1,2),
                            to =c("1-state", "n-state"))
fitd <- fitd[,c("specID", "best_model", "contingency", "study_str", "m1m3_diff")]
data <-merge(data, fitd, by="specID")
colnames(data)<-gsub(".x","",colnames(data))

### continuous model fit 
df2 <- data %>%
  group_by(id,oddball_str,contingency, best_model, study_str, ta) %>%
  summarise_at(c("mflr", "m1m3_diff"), mean, na.rm = TRUE)
df2 = df2 %>%
        group_by(oddball_str) %>%
        mutate(mflr = scale(mflr))
df2<-df2[df2$contingency %in% "90/10",]


m13c<-lm(mflr ~ ta*oddball_str , data = df2)
anova(m13c)
joint_tests(m13c, by = c("oddball_str"))
em13c <- emmeans(m13c, specs = pairwise ~ oddball_str  )
em13c$emmeans
em13c$contrasts
emtrends(m13c, pairwise ~ oddball_str, var = "ta")

m13c<-lm(mflr ~ m1m3_diff*oddball_str , data = df2)
anova(m13c)
joint_tests(m13c, by = c("oddball_str"))
em13c <- emmeans(m13c, specs = pairwise ~ oddball_str )
em13c$emmeans
em13c$contrasts
emtrends(m13c, pairwise ~ oddball_str , var = "m1m3_diff")

############### calcualte the difference 
library(tidyr)
df2<-df2 %>%
  pivot_wider(names_from = "oddball_str", values_from = "mflr")
df2$mflr_diff <- df2$meaningful - df2$oddball
m13c<-lm(mflr_diff ~ ta*m1m3_diff , data = df2)
m13c2<-lm(mflr_diff ~ best_model , data = df2)
anova(m13c)
em13c <- emmeans(m13c2, specs = pairwise ~ best_model  )
em13c$emmeans



```

### only 90/10 and oddball

```{r}



```


## Descriptives




```{r}
library(reshape2)
data<-read.csv(paste(path_root, "/output/tables_and_csvs/data_across_mods.csv", sep=""))
pal <- get_colors("ond")


g <- ggplot(data = data, aes(y = log_steepness_overall, x = contingency, fill = contingency)) +
geom_flat_violin(position = position_nudge(x = .2, y = 0), alpha = .8, lwd=1.2) +
geom_point(aes(y = log_steepness_overall, color=contingency), position = position_jitter(width = .15), size = 1, alpha = 0.5, show.legend = FALSE) +
geom_boxplot(width = .2, outlier.shape = NA, alpha = 0.7, lwd=1.2) +
expand_limits(x = 3) +

scale_color_manual(values = c(pal[5], pal[7], pal[9])) +
scale_fill_manual(values = c(pal[5], pal[7], pal[9])) +  
# coord_flip() +
theme_bw() +
raincloud_theme +
theme(legend.position = "right") + 
labs(y= "steepness (log)", x="Session") +
guides(fill=guide_legend(nrow=2,byrow=TRUE)) 

g

m<-lmer(data=data, log_steepness_overall ~ contingency + (1|ids))
anova(m)

```


```{r}
library(reshape2)
data<-read.csv(paste(path_root, "/output/tables_and_csvs/data_across_mods.csv", sep=""))
pal <- get_colors("ond")
g <- ggplot(data = data, aes(y = log_steepness_overall, x = contingency, fill = contingency)) +
geom_flat_violin(position = position_nudge(x = .2, y = 0), alpha = .8, lwd=1.2) +
geom_point(aes(y = log_steepness_overall, color=contingency), position = position_jitter(width = .15), size = 1, alpha = 0.5, show.legend = FALSE) +
geom_boxplot(width = .2, outlier.shape = NA, alpha = 0.7, lwd=1.2) +
expand_limits(x = 3) +

scale_color_manual(values = c(pal[5], pal[7], pal[9])) +
scale_fill_manual(values = c(pal[5], pal[7], pal[9])) +  
# coord_flip() +
theme_bw() +
raincloud_theme +
theme(legend.position = "right") + 
labs(y= "steepness (log)", x="Session") +
guides(fill=guide_legend(nrow=2,byrow=TRUE)) 

g

m<-lmer(data=data, log_steepness_overall ~ contingency + (1|ids))
anova(m)

```

```{r}
data<-read.csv(paste(path_root, "/output/tables_and_csvs/data_across_mods.csv", sep=""))
pal <- get_colors("ond")
g <- ggplot(data = data, aes(y = switchpoint_overall, x = contingency, fill = contingency)) +
geom_flat_violin(position = position_nudge(x = .2, y = 0), alpha = .8, lwd=1.2) +
geom_point(aes(y = switchpoint_overall, color=contingency), position = position_jitter(width = .15), size = 1, alpha = 0.5, show.legend = FALSE) +
geom_boxplot(width = .2, outlier.shape = NA, alpha = 0.7, lwd=1.2) +
expand_limits(x = 3) +

scale_color_manual(values = c(pal[5], pal[7], pal[9])) +
scale_fill_manual(values = c(pal[5], pal[7], pal[9])) +  
# coord_flip() +
theme_bw() +
raincloud_theme +
theme(legend.position = "right") + 
labs(y= "switchpoint", x="Session") +
guides(fill=guide_legend(nrow=2,byrow=TRUE)) 

g

m<-lmer(data=data, switchpoint_overall ~ contingency + (1|ids))
anova(m)
```
## Cross-relationships

### slope and steepness

```{r}
data<-read.csv(paste(path_root, "/output/tables_and_csvs/data_across_mods.csv", sep=""))
data$slope = (data$slope_acq + (data$slope_ext*-1))/2

pal <- get_colors("ond")
g <- ggplot(data = data, aes(y = log_steepness_overall, x = slope )) +
geom_point( size = 3, alpha = 0.5, show.legend = FALSE) +
geom_smooth(method='lm', formula= y~x, alpha=0.3) +
    facet_grid(cols=vars(contingency)) 
g


data %>% 
  nest(-contingency) %>% 
  mutate(cor=map(data,~cor.test(.x$log_steepness_overall, .x$slope, method = "kendall"))) %>%
  mutate(tidied = map(cor, tidy)) %>% 
  unnest(tidied, .drop = T)


```

### tau and steepness
```{r}
library(reshape2)
data<-read.csv(paste(path_root, "/output/tables_and_csvs/data_across_mods.csv", sep=""))
pal <- get_colors("ond")
g <- ggplot(data = data, aes(y = log_steepness_overall, x = tau_sh )) +
geom_point( size = 3, alpha = 0.5, show.legend = FALSE) +
geom_smooth(method='lm', formula= y~x, alpha=0.3) +
scale_fill_manual(values = c(pal[13], pal[13], pal[13])) +
theme_bw() +
raincloud_theme +
  labs(y= "log steepness", x="tau_sh") +
  facet_grid(cols=vars(contingency)) 
g
m<-lmer(data=data, log_steepness_overall ~ tau_sh + (1|ids))
anova(m)

g <- ggplot(data = data, aes(y = log_steepness_overall, x = tau_nosh )) +
geom_point( size = 3, alpha = 0.5, show.legend = FALSE) +
geom_smooth(method='lm', formula= y~x, alpha=0.3) +
scale_fill_manual(values = c(pal[13], pal[13], pal[13])) +
theme_bw() +
raincloud_theme +
  labs(y= "log steepness", x="tau noshock") +
  facet_grid(cols=vars(contingency)) 
g
m<-lmer(data=data, log_steepness_overall ~ tau_nosh + (1|ids))
anova(m)

```

### fit difference and steepness

```{r}

data<-read.csv(paste(path_root, "/output/tables_and_csvs/data_across_mods.csv", sep=""))
g <- ggplot(data = data, aes(y = IC_diff, x = log_steepness_overall )) +
geom_point( size = 3, alpha = 0.5, show.legend = FALSE) +
geom_smooth(method='lm', formula= y~x, alpha=0.3) +
scale_fill_manual(values = c(pal[13], pal[13], pal[13])) +
theme_bw() +
raincloud_theme +
  labs(y= "fit difference", x="log_steepness_overall") +
  facet_grid(cols=vars(contingency)) 
g

m<-lmer(data=data, log_steepness_overall ~ IC_diff*contingency + (1|ids))
anova(m)
joint_tests(m, by = "contingency")


df <- data[data$contingency %in% c("90/10"),]
g <- ggplot(data = df, aes(x = IC_diff, y = log_steepness_overall, color=(IC_diff) ), palette="Greens") +
geom_point( size = 3, alpha = 0.9, show.legend = FALSE) +
geom_smooth(method='lm', formula= y~x, alpha=0.3, show.legend = FALSE, color="black") +
scale_color_gradient(low="midnightblue", high="midnightblue") +
theme_bw() +
raincloud_theme +
  labs(x= "Relative fit", y="Estimated switch steepness") 
g

d<-data %>% 
  nest(-contingency) %>% 
  mutate(cor=map(data,~cor.test(.x$log_steepness_overall, .x$IC_diff, method = "pearson"))) %>%
  mutate(tidied = map(cor, tidy)) %>% 
  unnest(tidied, .drop = T)
d$p.value_corr <- p.adjust(d$p.value, method = "fdr")
d
```

### anxiety and steepness

```{r}
g <- ggplot(data = data, aes(y = log_steepness_overall, x = ta )) +
geom_point( size = 3, alpha = 0.5, show.legend = FALSE) +
geom_smooth(method='lm', formula= y~x, alpha=0.3) +
scale_fill_manual(values = c(pal[13], pal[13], pal[13])) +
theme_bw() +
raincloud_theme +
  labs(y= "log_steepness_overall", x="TA") +
  facet_grid(cols=vars(contingency)) 
g

m<-lmer(data=data, log_steepness_overall ~ ta*contingency + (1|ids) + (1|study))
anova(m)
joint_tests(m, by = "contingency")

df = data %>%
  group_by(ids, ta) %>%
  summarise_at("log_steepness_overall", mean, na.rm = TRUE)

g <- ggplot(data = df, aes(x = log_steepness_overall, y = ta, color=(log_steepness_overall) ), palette="Greens") +
geom_point( size = 3, alpha = 0.9, show.legend = FALSE) +
geom_smooth(method='lm', formula= y~x, alpha=0.3, show.legend = FALSE, color="black") +
scale_color_gradient(low="midnightblue", high="midnightblue") +
theme_bw() +
raincloud_theme +
  labs(x= "steepness", y="TA") 
g

data %>% 
  nest(-contingency) %>% 
  mutate(cor=map(data,~cor.test(.x$log_steepness_overall, .x$ta, method = "pearson"))) %>%
  mutate(tidied = map(cor, tidy)) %>% 
  unnest(tidied, .drop = T)

```

### anxiety and switchpoint

```{r}
data<-read.csv(paste(path_root, "/output/tables_and_csvs/data_across_mods.csv", sep=""))
g <- ggplot(data = data, aes(y = switchpoint_overall, x = ta )) +
geom_point( size = 3, alpha = 0.5, show.legend = FALSE) +
geom_smooth(method='lm', formula= y~x, alpha=0.3) +
scale_fill_manual(values = c(pal[13], pal[13], pal[13])) +
theme_bw() +
raincloud_theme +
  labs(y= "switchpoint", x="TA") +
  facet_grid(cols=vars(contingency)) 
g

m<-lmer(data=data, switchpoint_overall ~ ta*contingency + (1|ids) + (1|study))
anova(m)
joint_tests(m, by = "contingency")

df = data %>%
  group_by(ids, ta) %>%
  summarise_at("switchpoint_overall", mean, na.rm = TRUE)

g <- ggplot(data = df, aes(x = switchpoint_overall, y = ta, color=(switchpoint_overall) ), palette="Greens") +
geom_point( size = 3, alpha = 0.9, show.legend = FALSE) +
geom_smooth(method='lm', formula= y~x, alpha=0.3, show.legend = FALSE, color="black") +
scale_color_gradient(low="midnightblue", high="midnightblue") +
theme_bw() +
raincloud_theme +
  labs(x= "switchpoint", y="TA") 
g



```


### eta ad switchpoint

```{r}
g <- ggplot(data = data, aes(y = switchpoint_overall, x = eta )) +
geom_point( size = 3, alpha = 0.5, show.legend = FALSE) +
geom_smooth(method='lm', formula= y~x, alpha=0.3) +
scale_fill_manual(values = c(pal[13], pal[13], pal[13])) +
theme_bw() +
raincloud_theme +
  labs(y= "switch point", x="eta") +
  facet_grid(cols=vars(contingency)) 
g
#ggsave(paste(figpath, "Figure8_raw.pdf", sep=""), width = 8, height = 4, dpi = 120)
m<-lmer(data=data, switchpoint_overall ~ eta*contingency + (1|ids))
anova(m)
joint_tests(m, by = "contingency")

```


### fit difference ad switchpoint

```{r}
g <- ggplot(data = data, aes(x = switchpoint_overall, y = IC_diff )) +
geom_point( size = 3, alpha = 0.5, show.legend = FALSE) +
geom_smooth(method='lm', formula= y~x, alpha=0.3) +
scale_fill_manual(values = c(pal[13], pal[13], pal[13])) +
theme_bw() +
raincloud_theme +
  labs(y= "fit difference", x="switchpoint") +
  facet_grid(cols=vars(contingency)) 
g
#ggsave(paste(figpath, "Figure8_raw.pdf", sep=""), width = 8, height = 4, dpi = 120)
m<-lmer(data=data, switchpoint_overall ~ IC_diff*contingency + (1|ids))
anova(m)
joint_tests(m, by = "contingency")

```



### prob difference and ETA

```{r}
g <- ggplot(data = data, aes(y = prob_diff, x = eta )) +
geom_point( size = 3, alpha = 0.5, show.legend = FALSE) +
geom_smooth(method='lm', formula= y~x, alpha=0.3) +
scale_fill_manual(values = c(pal[13], pal[13], pal[13])) +
theme_bw() +
raincloud_theme +
  labs(y= "acq-ext", x="eta") +
  facet_grid(cols=vars(contingency)) 
g
m<-lmer(data=data, eta ~ prob_diff*contingency + (1|ids))
anova(m)
joint_tests(m, by = "contingency")
```

### anxiety and ETA

```{r}
g <- ggplot(data = data, aes(y = eta, x = ta )) +
geom_point( size = 3, alpha = 0.5, show.legend = FALSE) +
geom_smooth(method='lm', formula= y~x, alpha=0.3) +
scale_fill_manual(values = c(pal[13], pal[13], pal[13])) +
theme_bw() +
raincloud_theme +
  labs(y= "eta", x="ta") +
  facet_grid(cols=vars(contingency)) 
g
m<-lmer(data=data, eta ~ ta*contingency + (1|ids))
anova(m)
joint_tests(m, by = "contingency")
```
### fit difference and anx

```{r}
data<-read.csv(paste(path_root, "/output/tables_and_csvs/data_across_mods.csv", sep=""))
pal <- get_colors("ond")
g <- ggplot(data = data, aes(y = ta, x = IC_diff )) +
geom_point( size = 3, alpha = 0.5, show.legend = FALSE) +
geom_smooth(method='lm', formula= y~x, alpha=0.3) +
scale_fill_manual(values = c(pal[13], pal[13], pal[13])) +
theme_bw() +
raincloud_theme +
  #xlim(-70,120) +
  labs(y= "fit difference", x="trait anx") +
  facet_grid(cols=vars(contingency)) 
g

m<-lmer(data=data, IC_diff ~ ta*contingency + (1|ids))
anova(m)
joint_tests(m, by = "contingency")

df = data %>%
  group_by(ids) %>%
  summarise_at(c("ta", "IC_diff"), mean, na.rm = TRUE)
g <- ggplot(data = df, aes(y = ta, x = IC_diff )) +
geom_point( size = 3, alpha = 0.5, show.legend = FALSE) +
geom_smooth(method='lm', formula= y~x, alpha=0.3) +
scale_fill_manual(values = c(pal[13], pal[13], pal[13])) +
theme_bw() +
raincloud_theme +
  xlim(-70, 100 )
  labs(y= "ta", x="fit diff") 
g
cor.test(df$ta, df$IC_diff, method="pearson")

```
### fit difference (1- vs 2-state) and anx

```{r}
data<-read.csv(paste(path_root, "/output/tables_and_csvs/data_across_mods.csv", sep=""))
pal <- get_colors("ond")
g <- ggplot(data = data, aes(y = ta, x = m1m2_diff )) +
geom_point( size = 3, alpha = 0.5, show.legend = FALSE) +
geom_smooth(method='lm', formula= y~x, alpha=0.3) +
scale_fill_manual(values = c(pal[13], pal[13], pal[13])) +
theme_bw() +
raincloud_theme +
  #xlim(-70,120) +
  labs(y= "fit difference", x="trait anx") +
  facet_grid(cols=vars(contingency)) 
g

m<-lmer(data=data, m1m2_diff ~ ta*contingency + (1|ids))
anova(m)
joint_tests(m, by = "contingency")

df = data %>%
  group_by(ids) %>%
  summarise_at(c("ta", "m1m2_diff"), mean, na.rm = TRUE)
g <- ggplot(data = df, aes(y = ta, x = m1m2_diff )) +
geom_point( size = 3, alpha = 0.5, show.legend = FALSE) +
geom_smooth(method='lm', formula= y~x, alpha=0.3) +
scale_fill_manual(values = c(pal[13], pal[13], pal[13])) +
theme_bw() +
raincloud_theme +
  labs(y= "ta", x="fit diff") 
g
cor.test(df$ta, df$m1m2_diff, method="pearson")

```

### stable cues

```{r}
data<-read.csv(paste(path_root, "/output/tables_and_csvs/data_across_mods.csv", sep=""))
pal <- get_colors("ond")
g <- ggplot(data = data, aes(y = prob_diff, x = stables_prob_diff )) +
geom_point( size = 3, alpha = 0.5, show.legend = FALSE) +
geom_smooth(method='lm', formula= y~x, alpha=0.3) +
scale_fill_manual(values = c(pal[13], pal[13], pal[13])) +
theme_bw() +
raincloud_theme +
  labs(y= "reversal cue state difference", x="stable cues difference") +
  facet_grid(cols=vars(contingency)) 
g

m<-lmer(data=data, prob_diff ~ contingency*stables_prob_diff + (1|ids))
anova(m)
joint_tests(m, by = "contingency")

df = data %>%
  group_by(ids) %>%
  summarise_at(c("prob_diff", "stables_prob_diff"), mean, na.rm = TRUE)
g <- ggplot(data = df, aes(y = prob_diff, x = stables_prob_diff )) +
geom_point( size = 3, alpha = 0.5, show.legend = FALSE) +
geom_smooth(method='lm', formula= y~x, alpha=0.3) +
scale_fill_manual(values = c(pal[13], pal[13], pal[13])) +
theme_bw() +
raincloud_theme +
  labs(y= "reversal cue state difference", x="stable cues difference") 
g
cor.test(df$prob_diff, df$stables_prob_diff, method="kendall")
```


### ODDball learning in stable cues

```{r}
data<-read.csv(paste(path_root, "/output/full_behavioural_dataset_study_pX_real_data.csv", sep=""))
data <- data[which(data$Trial_Type %in% c(1,2,3)),]
df = data %>%
  group_by(id, contingency, Trial_Type, half_str, study_str, tabin, outcome_str) %>%
  summarise_at(c("mflr", "updates"), mean, na.rm = TRUE)


pal <- get_colors("ond2")

g <- ggplot(data = df, aes(y = mflr, x = half_str, fill = interaction(outcome_str,tabin))) +
geom_flat_violin(position = position_nudge(x = .2, y = 0), alpha = .8, lwd=1.2) +
#geom_point(aes(y = prob, color=trtype_str), position = position_jitter(width = .15), size = 1, alpha = 0.5, show.legend = FALSE) +

#geom_point(aes(color= interaction( outcome_str,trtype_str)), position =   position_jitterdodge(  jitter.width = .45,  dodge.width = 0.05), size = 2, alpha = 0.5, show.legend=FALSE) + 
geom_boxplot(width = .2, outlier.shape = NA, alpha = 0.7, lwd=1.2, show.legend = FALSE) +  
  #geom_boxplot(inherit.aes = TRUE, width = 0.8, lwd=1.2, outlier.shape = NA, alpha = 0.7, show.legend = FALSE) +  
  
expand_limits(x = 3) +

#scale_color_manual(values = c(pal[6], pal[5], pal[8], pal[7])) +
scale_fill_manual(values = c(pal[8], pal[6], pal[7], pal[5]),  name = "", labels = c("Nosh: Low Anxiety", "Sh: Low Anxiety", "Nosh: High Anxiety", "Sh: High Anxiety")) +
# coord_flip() +
theme_bw() +
raincloud_theme +
theme(legend.position = "right") + 
labs(y= "Mean probability", x="Session") +
  scale_x_discrete(labels=c("hi-prob" = "HC", "low-prob" =  "LC")) + 
guides(fill=guide_legend(nrow=4,byrow=TRUE)) +
facet_grid(cols=vars(contingency), rows = vars(Trial_Type)) 
g
ggsave(paste(figpath, "oddball_all_cues_half.pdf", sep=""), width =20, height = 10, dpi = 120)

```

### Analysis of surprise
just plot sum/mean surprise for acq/ext

```{r fig1, fig.height = 5, fig.width = 12}
data<-read.csv(paste(path_root, "/output/full_behavioural_dataset_study_pX_real_data.csv", sep=""))

data <- data[which(data$Trial_Type %in% c(3)),]
data <- data[which(data$Learning_Phase %in% c(1,2)),]
df = data %>%
  group_by(id, contingency, study_str,ta, tabin, phase_str) %>%
  summarise_at(c("surp"), mean, na.rm = TRUE)
df <- df[is.finite(df$surp),]
m<-lmer(data=df, surp ~ ta*phase_str*contingency + (1|id) + (1|study_str))
anova(m)

pal <- get_colors("ond")

g <- ggplot(data = df, aes(y = surp, x = phase_str, fill = interaction(phase_str, tabin))) +
geom_flat_violin(position = position_nudge(x = .2, y = 0), alpha = .8, lwd=1.2, show.legend = TRUE) +
geom_point(aes(color= interaction(phase_str, tabin)), position =   position_jitterdodge(  jitter.width = .15,  dodge.width = 0.25), size = 2, alpha = 0.5, show.legend=FALSE) + 

#geom_point(aes(y = mflr_overall, color=lrtype), position = position_jitter(width = .15), size = 2, alpha = 0.5, show.legend = FALSE) +
geom_boxplot(width = .2, outlier.shape = NA, alpha = 0.7, lwd=1.2, show.legend = FALSE) +
expand_limits(x = 3) +

scale_color_manual(values = c("pink3","cyan3", "darkred", "darkslategrey") ) +
scale_fill_manual(values = c("pink3","cyan3", "darkred", "darkslategrey") ) + #, name="", labels=c("Meaningful: Low Anx", "Oddball: Low Anx", "Meaningful: High Anx", "Oddball: High Anx" )) +  
# coord_flip() +
theme_bw() +
raincloud_theme +
theme(legend.position = "right") + 
labs(y= "Suprise", x="") +
  scale_x_discrete(labels=c("common" = "Meaningful", "odd" =  "Oddball")) + 
guides(fill=guide_legend(nrow=4,byrow=TRUE)) + 
  facet_grid(cols=vars(contingency))

g

```

## Reaction times
### cue, session and anx
```{r fig.width=10}
data<-read.csv(paste(path_root, "/output/full_behavioural_dataset_study_pX_real_data.csv", sep=""))
data<-assign_var_types(data, c("study", "ta", "phase_str", "half_str", "cont", "trial_type_str", "outcome_str", "tabin", "session"))
data<-data[data$RT>0,]
hist(data$RT[data$RT>0], 100)
# cue, session and outcome
df = data %>%
  group_by(id, contingency, study_str,trial_type_str,tabin, ta, outcome_str) %>%
  summarise_at(c("RT"), mean, na.rm = TRUE)

m<-lmer(data=df, RT ~ contingency*trial_type_str*ta + (1|id) + (1|study_str))
m2<-lmer(data=df, RT ~ trial_type_str + (1|id) + (1|study_str))
anova(m)
em<-emmeans(m2, pairwise~trial_type_str)
em$emmeans
em$contrasts

pal <- get_colors("ond2")
g <- ggplot(data = df, aes(y = RT, x = trial_type_str, fill = interaction(trial_type_str, outcome_str))) +
geom_flat_violin(position = position_nudge(x = .2, y = 0), alpha = .7,lwd=1.2) +
#geom_point(aes(y = condval), position = position_jitter(width = .15), size = 1, alpha = 0.5, show.legend = FALSE) +
  geom_point(aes(color= interaction(trial_type_str, outcome_str)), position =   position_jitterdodge(  jitter.width = .15,  dodge.width = 0.2), size = 2, alpha = 0.5, show.legend=FALSE) +  

geom_boxplot(width = .2, outlier.shape = NA, alpha = 0.7, lwd=1.2, show.legend = FALSE) +
geom_hline(yintercept=c(0), linetype="dashed") +
expand_limits(x = 3) +
scale_color_manual(values = pal[c(4,4,4,1,1,1)]) +
scale_fill_manual(values =  pal[c(4,4,4,1,1,1)], name="") +
# coord_flip() +

theme_bw() +
raincloud_theme +
theme(strip.text.x = element_text(size = 14,  face = "bold"),
    strip.background = element_rect(color="black", fill="#ebebeb", size=0, linetype="solid")) +
labs(y= "RT", x="Session") + 
scale_x_discrete(labels=c("acq" = "High", "ext" =  "Low")) +
#scale_y_continuous(labels = function(x) paste0(x*100, "%")) +

facet_grid(cols=vars(contingency)) 
g

```

### reversal cue - post-reversal trial no by phase
```{r fig.width=10}
data<-read.csv(paste(path_root, "/output/full_behavioural_dataset_study_pX_real_data.csv", sep=""))
data<-assign_var_types(data, c("study", "ta", "phase_str", "half_str", "cont", "trial_type_str", "outcome_str", "tabin", "session"))
data<-data[data$RT>0,]
data<-data[which(data$Trial_Type %in% 3),]
data<-data[which(data$trno %in% seq(1,10)),]
data<-data[which(data$rev_type_4plot %in% c("acq","ext")),]
df = data %>%
  group_by(id, contingency,trno,study_str,phase_str,tabin, ta) %>%
  summarise_at(c("RT"), mean, na.rm = TRUE)


pal <- get_colors("ond2")
g <- ggplot(data = df, aes(y = RT, x = phase_str, fill = interaction(phase_str, tabin))) +
#geom_flat_violin(position = position_nudge(x = .2, y = 0), alpha = .7,lwd=1.2) +
#geom_point(aes(y = condval), position = position_jitter(width = .15), size = 1, alpha = 0.5, show.legend = FALSE) +
  geom_point(aes(color= interaction(phase_str, tabin)), position =   position_jitterdodge(  jitter.width = .15,  dodge.width = 0.2), size = 2, alpha = 0.5, show.legend=FALSE) +  

geom_boxplot(width = .2, outlier.shape = NA, alpha = 0.7, lwd=1.2, show.legend = TRUE) +
geom_hline(yintercept=c(0), linetype="dashed") +
expand_limits(x = 3) +
##scale_color_manual(values = pal[c(4,4,4,3,3,3)]) +
#scale_fill_manual(values =  pal[c(4,4,4,3,3,3)], name="") +
# coord_flip() +

theme_bw() +
raincloud_theme +
theme(strip.text.x = element_text(size = 14,  face = "bold"),
    strip.background = element_rect(color="black", fill="#ebebeb", size=0, linetype="solid")) +
labs(y= "RT", x="Session") + 
#scale_x_discrete(labels=c("acq" = "High", "ext" =  "Low")) +
#scale_y_continuous(labels = function(x) paste0(x*100, "%")) +
ylim(0,5) +
facet_grid(cols=vars(contingency)) 
g
ggsave(paste(figpath, "RT_by_trial.pdf", sep=""), width = 10, height = 5, dpi = 120)

df = data %>%
  group_by(id, contingency,study_str,phase_str,tabin, ta) %>%
  summarise_at(c("RT"), mean, na.rm = TRUE)
m<-lmer(data=df, RT ~ contingency*phase_str*ta + (1|id) + (1|study_str))
anova(m)

```